<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">

    <style>
        /* Ù†ÙØ³ Ø§Ù„Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± */
        :root {
            --primary-color: #007BFF;
            --primary-dark: #0056b3;
            --background-light: #f5f7f9;
            --box-shadow-subtle: 0 4px 15px rgba(0,0,0,0.08);
            --box-shadow-hover: 0 10px 25px rgba(0,0,0,0.15);
            --text-color-dark: #212529;
        }

        .page-wrapper {
            margin-right: 260px;
            padding: 20px;
        }
        body {
            background: var(--background-light);
            font-family: 'Tajawal', sans-serif;
            color: var(--text-color-dark);
        }

        .dashboard-header {
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            border-radius: 20px;
            color: #fff;
            margin-bottom: 2rem;
            box-shadow: 0 10px 25px rgba(0, 123, 255, 0.4);
            font-weight: 700;
        }

        .dashboard-header h3 { font-weight: 800; }

        .badge-advanced {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 12px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .stat-card {
            border-radius: 18px;
            padding: 1.5rem;
            background: #fff;
            box-shadow: var(--box-shadow-subtle);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            text-align: center;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--box-shadow-hover);
        }

        .stat-card h3 {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--primary-dark);
        }
        .stat-card h6 {
            font-weight: 600;
            color: var(--text-color-dark);
        }
        .stat-card small { color: #6c757d; }

        .section-card {
            border-radius: 18px;
            padding: 1.8rem;
            background: #ffffff;
            box-shadow: var(--box-shadow-subtle);
            margin-bottom: 1.5rem;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .section-card h5, .section-card h6 {
            font-weight: 700;
            margin-bottom: 1.2rem;
            color: var(--primary-dark);
        }

        .section-card ol { padding-right: 20px; margin-bottom: 0; }

        .section-card ol li {
            padding: 8px 0;
            border-bottom: 1px dashed rgba(0,0,0,0.05);
            font-size: 0.95rem;
            color: var(--text-color-dark);
            font-weight: 500;
        }
        .section-card ol li:last-child { border-bottom: none; }

        .alert-warning {
            background-color: #fff3cd;
            border-color: #ffecb5;
            color: #664d03;
        }
        .alert ul { margin-bottom: 0; }

        canvas {
            max-width: 100% !important;
            background: #fff;
            border-radius: 10px;
        }
        .section-card h5 i { color: var(--primary-color); margin-left: 8px; }

        @media (max-width: 576px) {
            h3 { font-size: 1.8rem; }
            .page-wrapper { margin-right: 0; padding: 10px; }
            .dashboard-header { border-radius: 15px; margin-bottom: 1.5rem; }
            .stat-card h3 { font-size: 2rem; }
        }
    </style>
</head>

<body class="p-3">

<div th:replace="fragments/sidebar :: doctorSidebar()"></div>
<div th:replace="fragments/chat-popup :: chatPopupFragment"></div>

<div class="page-wrapper">

    <div class="dashboard-header d-flex flex-wrap justify-content-between align-items-center">
        <h3 class="mb-2" th:text="${clinic.name} + ' - Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…'">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h3>
        <span class="badge-advanced mt-2" th:text="${clinic.subscriptionType}">ADVANCED</span>
    </div>

    <div class="row g-3">
        <div class="col-12 col-sm-6 col-lg-4 col-xl-3">
            <div class="stat-card">
                <h6>Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h6>
                <h3 th:text="${dashboard.visitsToday}">0</h3>
                <small>ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±: <span th:text="${dashboard.waitingToday}">0</span></small>
            </div>
        </div>

        <div class="col-12 col-sm-6 col-lg-4 col-xl-3">
            <div class="stat-card">
                <h6>Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø§Ù„Ø¬Ø¯Ø¯</h6>
                <h3 th:text="${dashboard.newPatientsToday}">0</h3>
            </div>
        </div>

        <div class="col-12 col-sm-6 col-lg-4 col-xl-3">
            <div class="stat-card">
                <h6>Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h6>
                <h3 th:text="${dashboard.revenueToday}">0.0</h3>
            </div>
        </div>
    </div>

    <div class="mt-4" th:if="${dashboard.alerts.size() > 0}">
        <div class="alert alert-warning shadow-sm">
            <ul>
                <li th:each="a : ${dashboard.alerts}" th:text="${a}"></li>
            </ul>
        </div>
    </div>

    <div class="row mt-3">
        <div class="col-12 col-lg-8">
            <div class="section-card">
                <h5><i class="bi bi-bar-chart-line"></i> Ø²ÙŠØ§Ø±Ø§Øª ÙƒÙ„ Ø·Ø¨ÙŠØ¨ (Ø§Ù„ÙŠÙˆÙ…)</h5>
                <canvas id="visitsPerDoctorChart"></canvas>
            </div>
            <div class="section-card">
                <h5><i class="bi bi-graph-up"></i> Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</h5>
                <canvas id="weeklyRevenueChart"></canvas>
            </div>
            <div class="section-card">
                <h5><i class="bi bi-pie-chart"></i> Ù†ÙˆØ¹ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª (Ø§Ù„ÙŠÙˆÙ…)</h5>
                <canvas id="visitTypeChart"></canvas>
            </div>
        </div>

        <div class="col-12 col-lg-4">
            <div class="section-card">
                <h6><i class="bi bi-people-fill"></i> Ø£ÙƒØ«Ø± Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø²ÙŠØ§Ø±Ø©</h6>
                <ol>
                    <li th:each="p : ${dashboard.topPatients}"
                        th:text="${p.name + ' â€” ' + p.visitsCount}">
                    </li>
                </ol>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<script th:inline="javascript">
    // ÙƒÙˆØ¯ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…
    const visitsPerDoctor = [[${dashboard.visitsPerDoctor}]];
    const weeklyRevenue   = [[${dashboard.weeklyRevenue}]];
    const visitType       = [[${dashboard.visitTypeBreakdown}]];

    const doctorLabels = visitsPerDoctor.map(i => i.name);
    const doctorData   = visitsPerDoctor.map(i => i.value);

    const visitTypeLabels = Object.keys(visitType);
    const visitTypeData   = Object.values(visitType);

    const weekLabels = [...Array(7)].map((_, i) => {
        const d = new Date();
        d.setDate(d.getDate() - (6 - i));
        return d.toLocaleDateString('ar-EG', { weekday: 'short' });
    });

    // Chart Config
    Chart.defaults.font.family = 'Tajawal';
    Chart.defaults.color = '#495057';
    const primaryColor = '#007BFF';
    const primaryDark  = '#0056b3';
    const chartAccentColors = ['#007BFF', '#28A745', '#FFC107', '#DC3545', '#17A2B8'];

    new Chart(document.getElementById('visitsPerDoctorChart'), {
        type: 'bar',
        data: {
            labels: doctorLabels,
            datasets: [{ data: doctorData, backgroundColor: primaryColor, borderRadius: 4 }]
        },
        options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
    });

    new Chart(document.getElementById('weeklyRevenueChart'), {
        type: 'line',
        data: {
            labels: weekLabels,
            datasets: [{
                data: weeklyRevenue,
                label: 'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                borderColor: primaryColor,
                borderWidth: 3,
                tension: 0.4,
                fill: true,
                pointRadius: 5
            }]
        },
        options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
    });

    new Chart(document.getElementById('visitTypeChart'), {
        type: 'pie',
        data: {
            labels: visitTypeLabels,
            datasets: [{ data: visitTypeData, backgroundColor: chartAccentColors, hoverOffset: 10 }]
        },
        options: { responsive: true, plugins: { legend: { position: 'right' } } }
    });


    // =======================================================
    // âœ… 2. Ø£Ø¶ÙÙ†Ø§ ÙƒÙˆØ¯ Ø§Ù„Ø´Ø§Øª Ù‡Ù†Ø§ (Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨)
    // =======================================================
    console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„Ø´Ø§Øª ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©...');

    (function() {
        // Ù‡Ø§Ù…: ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù€ Controller Ø§Ù„Ø®Ø§Øµ Ø¨ØµÙØ­Ø© Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© ÙŠØ±Ø³Ù„ ÙƒØ§Ø¦Ù† doctor Ø£Ùˆ user
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‡Ùˆ Ù†ÙØ³ Ø§Ù„Ø·Ø¨ÙŠØ¨ØŒ ÙØ§Ù„ÙƒÙˆØ¯ Ø§Ù„ØªØ§Ù„ÙŠ Ø³ÙŠØ¹Ù…Ù„.
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø®Ø·Ø£ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† "doctor.id" Ù…ØªØ§Ø­ ÙÙŠ Ø§Ù„Ù€ Model Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©
        const currentUserId = /*[[${doctor != null ? doctor.id : 0}]]*/ 0;

        console.log('ğŸ‘¤ User ID:', currentUserId);

        const sidebarBadge = document.getElementById('sidebarChatBadge');

        if (!sidebarBadge) return;

        let stompClient = null;
        let unreadCount = 0;

        function updateBadge(count) {
            unreadCount = count;
            sidebarBadge.textContent = count > 99 ? '99+' : count;
            sidebarBadge.style.display = count > 0 ? "flex" : "none";
            if (count > 0) sidebarBadge.style.animation = 'pulse 2s infinite';
            localStorage.setItem('chatUnreadCount_' + currentUserId, count);
        }

        function loadUnreadCount() {
            const stored = localStorage.getItem('chatUnreadCount_' + currentUserId);
            updateBadge(stored ? parseInt(stored) : 0);
        }

        function connectWebSocket() {
            try {
                const socket = new SockJS('/ws');
                stompClient = Stomp.over(socket);
                stompClient.debug = null; // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù„ÙˆØ¬ Ø§Ù„ÙƒØ«ÙŠØ±

                stompClient.connect({}, function(frame) {
                    stompClient.subscribe('/user/' + currentUserId + '/queue/messages', function(message) {
                        try {
                            const msg = JSON.parse(message.body);
                            if (msg.senderId !== currentUserId) {
                                unreadCount++;
                                updateBadge(unreadCount);
                                playNotificationSound();
                            }
                        } catch (e) { console.error(e); }
                    });
                    loadUnreadCount();
                }, function(error) {
                    setTimeout(connectWebSocket, 5000);
                });
            } catch (error) { console.error(error); }
        }

        function playNotificationSound() {
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBzKF0fPTgjMGHm7A7+OZUQ0PVqzn77BdGAg+ltryxnYpBSuBzvLZiTYIGWa77+ifTRAMT6Ti8LZjHAY3kdnyzXksBSV3yPDdkEAKFF+16+usVRQLRp/h8r1sIAcyhdHz04IzBh9uwPDjmVAND1as5++wXRgIPpbb8sV2KQUrgdDy2Yk2CBlmvO/pn00QDE6k4/C2YxwGOJHa8s15LAUmeMnw3ZBADRRGU=');
                audio.volume = 0.3;
                audio.play().catch(e => {});
            } catch (e) {}
        }

        window.addEventListener('storage', function(event) {
            if (event.key === 'chatUnreadCount_' + currentUserId) {
                updateBadge(parseInt(event.newValue) || 0);
            }
        });

        window.addEventListener('load', function() {
            setTimeout(function() {
                connectWebSocket();
                fetch('/chat/unread-count')
                    .then(res => res.json())
                    .then(count => updateBadge(count))
                    .catch(e => {});
            }, 500);
        });
    })();
</script>

</body>
</html>