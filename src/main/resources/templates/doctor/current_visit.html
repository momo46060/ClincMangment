<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø§Ù„ÙƒØ´Ù Ø§Ù„Ø­Ø§Ù„ÙŠ</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">

    <style>
        /*
         * ======================================
         * ØªØ®ØµÙŠØµ Ø§Ù„Ø³ØªØ§ÙŠÙ„ Ù„Ù„Ø£Ø²Ø±Ù‚ Ø§Ù„Ø·Ø¨ÙŠ Ø§Ù„ÙØ§Ø®Ø± (Medical Blue Visit Page)
         * ======================================
         */
        :root {
            --primary-color: #007BFF; /* Ø£Ø²Ø±Ù‚ Ù…ÙˆØ«ÙˆÙ‚ Ù„Ù„ØªØ±ÙƒÙŠØ² */
            --primary-dark: #0056b3;  /* Ù„Ù„ØªÙØ§Ø¹Ù„ ÙˆØ§Ù„Ø¹Ù…Ù‚ */
            --primary-light: #E6F3FF; /* Ù„ÙˆÙ† ÙØ§ØªØ­ Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ø®Ù„ÙÙŠØ§Øª */
            --text-color-dark: #212529;
        }

        .page-wrapper {
            margin-right: 260px;
            padding: 20px;
        }

        body {
            /* Ø®Ù„ÙÙŠØ© Ø¨ÙŠØ¶Ø§Ø¡ Ù…Ø²Ø±Ù‚Ø© Ù†Ø¸ÙŠÙØ© */
            background: #f8faff;
            font-family: 'Tajawal', sans-serif;
            color: var(--text-color-dark);
            min-height: 100vh;
            padding-bottom: 80px;
        }

        h2 {
            /* Ù„ÙˆÙ† Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø¨Ø§Ù„Ø£Ø²Ø±Ù‚ Ø§Ù„Ø¯Ø§ÙƒÙ† */
            color: var(--primary-dark);
            font-weight: 800;
            font-size: 2rem;
        }

        /* ØªÙ„ÙˆÙŠÙ† Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø¨Ø§Ù„Ø£Ø²Ø±Ù‚ */
        h2 .bi-heart-pulse-fill {
            color: var(--primary-color) !important;
        }

        /* Ø§Ù„ÙƒØ§Ø±Ø¯ - Ù…Ø¸Ù‡Ø± Ø¹Ø§Ø¦Ù… ÙˆØ£Ù†ÙŠÙ‚ */
        .card {
            border: none;
            border-radius: 18px; /* Ø­ÙˆØ§Ù Ø£ÙƒØ«Ø± Ø¯Ø§Ø¦Ø±ÙŠØ© */
            overflow: hidden;
            /* Ø¸Ù„ Ù†Ø§Ø¹Ù… ÙˆÙˆØ§Ø¶Ø­ */
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-4px); /* ØªØ£Ø«ÙŠØ± Ø±ÙØ¹ Ø£ÙƒØ¨Ø± */
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
        }

        /* Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„ÙƒØ§Ø±Ø¯ - Ø®Ù„ÙÙŠØ© Ø«Ø§Ø¨ØªØ© Ù„Ù„Ø£Ø²Ø±Ù‚ */
        .card-header {
            font-weight: 700;
            font-size: 1.15rem;
            color: white;
            /* Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙØ¦Ø© Ø¨ÙˆÙˆØªØ³ØªØ±Ø§Ø¨ Ù„ØªÙ…Ø«ÙŠÙ„ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø²Ø±Ù‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
            background-color: var(--primary-color) !important;
            padding: 1rem 1.5rem;
        }

        .card-header.bg-secondary {
            background-color: var(--primary-dark) !important; /* Ù„ÙˆÙ† Ø£ØºÙ…Ù‚ Ù„Ø³Ø¬Ù„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª */
        }

        .form-control, textarea {
            border-radius: 12px;
            border: 1px solid #ced4da;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            font-size: 1rem;
            padding: 0.75rem;
        }

        .form-control:focus, textarea:focus {
            /* Ø¥Ø·Ø§Ø± ØªØ±ÙƒÙŠØ² Ø£Ø²Ø±Ù‚ */
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25);
        }

        .btn {
            border-radius: 12px;
            font-weight: 700;
            transition: all 0.3s ease;
        }

        /* Ø²Ø± Ø§Ù„Ø­ÙØ¸ (Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ) */
        .btn-success {
            background-color: var(--primary-color) !important;
            border-color: var(--primary-color) !important;
        }

        .btn-success:hover {
            background-color: var(--primary-dark) !important;
            border-color: var(--primary-dark) !important;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.4);
        }

        /* Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© (Secondary/Outline) */
        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
            background-color: transparent;
        }
        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            color: white;
        }

        /* Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© (Secondary) */
        .btn-secondary {
            background-color: #e9ecef !important;
            color: var(--text-color-dark) !important;
            border-color: #e9ecef !important;
        }
        .btn-secondary:hover {
            background-color: #dee2e6 !important;
            border-color: #dee2e6 !important;
        }


        /* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© */
        .table th {
            /* Ø®Ù„ÙÙŠØ© Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø²Ø±Ù‚ Ø§Ù„Ø¯Ø§ÙƒÙ† */
            background: var(--primary-dark) !important;
            color: #fff;
            text-align: center;
            font-weight: 700;
        }

        .table td {
            background: #fff;
            font-size: 0.95rem;
            border-color: rgba(0, 0, 0, 0.08); /* Ø­Ø¯ÙˆØ¯ ÙØ§ØªØ­Ø© */
        }

        /* Multi-line text for previous visits */
        .multiline-text {
            white-space: pre-wrap;
            line-height: 1.8;
            background: var(--primary-light); /* Ø®Ù„ÙÙŠØ© ÙØ§ØªØ­Ø© Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ù‚ */
            border-radius: 10px;
            padding: 10px;
            font-size: 0.9rem;
            border: 1px solid rgba(0, 123, 255, 0.1);
        }

        textarea {
            line-height: 1.7;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            h2 {
                font-size: 1.6rem;
            }

            .card-header {
                font-size: 1rem;
            }
            .page-wrapper {
                margin-right: 0;
            }

            .btn {
                padding: 8px 15px;
                font-size: 0.95rem;
            }

            .form-control, textarea {
                font-size: 0.9rem;
            }

            .table {
                font-size: 0.8rem;
            }

            .table-responsive {
                overflow-x: auto;
            }
        }

        @media (max-width: 480px) {
            .btn {
                width: 100%;
                margin-bottom: 8px;
            }
        }
    </style>
</head>

<body class="p-3">
<div th:replace="fragments/sidebar :: doctorSidebar()"></div>
<div th:replace="fragments/chat-popup :: chatPopupFragment"></div>

<div class="page-wrapper">

    <h2 class="mb-4 text-center">
        <i class="bi bi-heart-pulse-fill text-success"></i> Ø§Ù„ÙƒØ´Ù Ø§Ù„Ø¬Ø§Ø±ÙŠ
    </h2>

    <div class="card mb-4">
        <div class="card-header bg-primary text-white"><i class="bi bi-person-lines-fill"></i> Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶</div>
        <div class="card-body">
            <p><strong>Ø§Ù„Ø§Ø³Ù…:</strong> <span id="patientName" th:text="${patient.user.fullName}"></span></p>
            <p><strong>Ø§Ù„ÙƒÙˆØ¯:</strong> <span id="patientCode" th:text="${patient.patientCode}"></span></p>
            <p><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> <span id="patientPhone" th:text="${patient.user.phone}"></span></p>
        </div>
    </div>

    <form th:action="@{/doctor/visit/update}" method="post">
        <input type="hidden" name="visitId" th:value="${visit.id}"/>

        <div class="card mb-4">
            <div class="card-header bg-primary text-white"><i class="bi bi-file-medical"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            </div>

            <div class="card-body">

                <p><strong>Ø§Ù„Ù†ÙˆØ¹:</strong> <span th:text="${visit.visitType}"></span></p>
                <p><strong>Ø§Ù„Ø´ÙƒÙˆÙ‰:</strong> <span th:text="${visit.complaint}"></span></p>
                <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong>
                    <span th:text="${#temporals.format(visit.visitDate, 'yyyy-MM-dd HH:mm')}"></span>
                </p>

                <div class="mt-3">
                    <label class="form-label fw-bold">Ø§Ù„ØªØ´Ø®ÙŠØµ</label>
                    <textarea id="diagnosisField" class="form-control" name="diagnosis" rows="4"
                              th:text="${visit.diagnosis}"></textarea>
                </div>

                <div class="mt-3">
                    <label class="form-label fw-bold">Ø§Ù„Ø¹Ù„Ø§Ø¬</label>
                    <textarea id="prescriptionField" class="form-control" name="prescription" rows="5"
                              th:text="${visit.prescription}"></textarea>
                </div>

                <div class="mt-3">
                    <label class="form-label fw-bold">Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</label>
                    <input type="datetime-local" class="form-control" name="scheduledConsultation"
                           th:value="${visit.scheduledConsultation != null ? #temporals.format(visit.scheduledConsultation, 'yyyy-MM-dd''T''HH:mm') : ''}"/>
                </div>

                <div class="mt-4 text-center d-flex flex-wrap justify-content-center gap-2">
                    <button type="submit" class="btn btn-success px-4"><i class="bi bi-save"></i> Ø­ÙØ¸</button>
                    <button type="button" class="btn btn-outline-primary px-4" onclick="printPrescription()"><i
                            class="bi bi-printer"></i> Ø·Ø¨Ø§Ø¹Ø©
                    </button>
                    <button type="button" class="btn btn-success px-4" onclick="sendWhatsAppPrescription()"><i
                            class="bi bi-whatsapp"></i> ÙˆØ§ØªØ³Ø§Ø¨
                    </button>
                    <a href="#" onclick="history.back()" class="btn btn-secondary px-4"><i
                            class="bi bi-arrow-right"></i> Ø¹ÙˆØ¯Ø©</a>
                </div>

            </div>
        </div>
    </form>

    <div class="card mb-5">
        <div class="card-header bg-secondary text-white"><i class="bi bi-clock-history"></i> Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</div>
        <div class="card-body">

            <div class="table-responsive">
                <table class="table table-bordered table-striped align-middle">
                    <thead>
                    <tr>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>Ø§Ù„Ù†ÙˆØ¹</th>
                        <th>Ø§Ù„Ø´ÙƒÙˆÙ‰</th>
                        <th>Ø§Ù„ØªØ´Ø®ÙŠØµ</th>
                        <th>Ø§Ù„Ø¹Ù„Ø§Ø¬</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="v : ${previousVisits}">
                        <td class="text-center" th:text="${#temporals.format(v.visitDate, 'yyyy-MM-dd')}"></td>
                        <td class="text-center" th:text="${v.visitType}"></td>
                        <td th:text="${v.complaint}"></td>
                        <td>
                            <div class="multiline-text"
                                 th:utext="${#strings.replace(v.diagnosis, '\n', '<br/>')}"></div>
                        </td>
                        <td>
                            <div class="multiline-text"
                                 th:utext="${#strings.replace(v.prescription, '\n', '<br/>')}"></div>
                        </td>
                    </tr>

                    <tr th:if="${#lists.isEmpty(previousVisits)}">
                        <td colspan="5" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª Ø³Ø§Ø¨Ù‚Ø©</td>
                    </tr>
                    </tbody>
                </table>
            </div>

        </div>
    </div>

</div>

<script>
    function printPrescription() {
        const patientName = document.getElementById('patientName').innerText.trim();
        const diagnosis = document.getElementById('diagnosisField').value.trim();
        const prescription = document.getElementById('prescriptionField').value.trim();
        const consultationDateInput = document.querySelector('input[name="scheduledConsultation"]').value;

        let formattedDate = '';
        if (consultationDateInput) {
            const dateObj = new Date(consultationDateInput);
            formattedDate = dateObj.toLocaleString('ar-EG', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        const printWindow = window.open('', '_blank', 'width=800,height=600');

        printWindow.document.write(`
        <!DOCTYPE html>
        <html lang="ar" dir="rtl">
        <head>
            <meta charset="UTF-8">
            <title>ÙˆØµÙØ© Ø·Ø¨ÙŠØ©</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
            <style>
                body { font-family: 'Tajawal', sans-serif; padding: 40px; line-height: 2; }
                .content { white-space: pre-wrap; background:#E6F3FF; padding: 20px; border-radius: 10px; border: 1px solid #007BFF; }
                h2, h5 { color: #0056b3; font-weight: 700; }
            </style>
        </head>
        <body>
            <h2 class="text-center mb-4">ÙˆØµÙØ© Ø·Ø¨ÙŠØ©</h2>

            <h5>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶:</h5>
            <div class="content">${patientName}</div>

            <h5 class="mt-3">Ø§Ù„ØªØ´Ø®ÙŠØµ:</h5>
            <div class="content">${diagnosis.replace(/\n/g, '<br>')}</div>

            <h5 class="mt-3">Ø§Ù„Ø¹Ù„Ø§Ø¬:</h5>
            <div class="content">${prescription.replace(/\n/g, '<br>')}</div>

            ${formattedDate ? `
            <h5 class="mt-3">Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©:</h5>
            <div class="content">${formattedDate}</div>` : ''}

            <p class="text-center mt-4" style="color:#007BFF; font-weight:600">Ù†ØªÙ…Ù†Ù‰ Ù„ÙƒÙ… Ø§Ù„Ø´ÙØ§Ø¡ Ø§Ù„Ø¹Ø§Ø¬Ù„ ğŸŒ¿</p>
        </body>
        </html>
        `);

        printWindow.document.close();
        printWindow.print();
    }

    async function sendWhatsAppPrescription() {
        try {
            const patientName = document.getElementById('patientName').innerText.trim();
            let patientPhone = document.getElementById('patientPhone').innerText.trim();
            const diagnosis = document.getElementById('diagnosisField').value.trim();
            const prescription = document.getElementById('prescriptionField').value.trim();
            const consultationDateInput = document.querySelector('input[name="scheduledConsultation"]').value;

            if (!patientPhone) {
                alert('Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø±ÙŠØ¶ ØºÙŠØ± Ù…ØªÙˆÙØ±');
                return;
            }

            patientPhone = patientPhone.replace(/\D/g, '');
            if (!patientPhone.startsWith("20")) {
                patientPhone = "20" + patientPhone;
            }

            let formattedDate = '';
            if (consultationDateInput) {
                const dateObj = new Date(consultationDateInput);
                formattedDate = dateObj.toLocaleString('ar-EG', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            let message =
                `ğŸ¥ ÙˆØµÙØ© Ø·Ø¨ÙŠØ©\n\n` +
                `Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶: ${patientName}\n\n` +
                `Ø§Ù„ØªØ´Ø®ÙŠØµ:\n${diagnosis}\n\n` +
                `Ø§Ù„Ø¹Ù„Ø§Ø¬:\n${prescription}\n\n` +
                (formattedDate ? `Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©: ${formattedDate}\n\n` : "") +
                `ØªÙ…Ù†ÙŠØ§ØªÙ†Ø§ Ø¨Ø§Ù„Ø´ÙØ§Ø¡ Ø§Ù„Ø¹Ø§Ø¬Ù„ ğŸŒ¿`;

            const whatsappUrl = `https://wa.me/${patientPhone}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');

        } catch (error) {
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙˆØµÙØ©. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
        }
    }
</script>

</body>
</html>