<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø§Ù„ÙƒØ´Ù Ø§Ù„Ø­Ø§Ù„ÙŠ</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap"
          rel="stylesheet">

    <style>

        :root {
            --primary-color: #007BFF; /* Ø£Ø²Ø±Ù‚ Ù…ÙˆØ«ÙˆÙ‚ Ù„Ù„ØªØ±ÙƒÙŠØ² */
            --primary-dark: #0056b3; /* Ù„Ù„ØªÙØ§Ø¹Ù„ ÙˆØ§Ù„Ø¹Ù…Ù‚ */
            --primary-light: #E6F3FF; /* Ù„ÙˆÙ† ÙØ§ØªØ­ Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ø®Ù„ÙÙŠØ§Øª */
            --text-color-dark: #212529;
        }

        .page-wrapper {
            margin-right: 260px;
            padding: 20px;
        }

        body {
            /* Ø®Ù„ÙÙŠØ© Ø¨ÙŠØ¶Ø§Ø¡ Ù…Ø²Ø±Ù‚Ø© Ù†Ø¸ÙŠÙØ© */
            background: #f8faff;
            font-family: 'Tajawal', sans-serif;
            color: var(--text-color-dark);
            min-height: 100vh;
            padding-bottom: 80px;
        }

        h2 {
            /* Ù„ÙˆÙ† Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø¨Ø§Ù„Ø£Ø²Ø±Ù‚ Ø§Ù„Ø¯Ø§ÙƒÙ† */
            color: var(--primary-dark);
            font-weight: 800;
            font-size: 2rem;
        }

        /* ØªÙ„ÙˆÙŠÙ† Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø¨Ø§Ù„Ø£Ø²Ø±Ù‚ */
        h2 .bi-heart-pulse-fill {
            color: var(--primary-color) !important;
        }

        /* Ø§Ù„ÙƒØ§Ø±Ø¯ - Ù…Ø¸Ù‡Ø± Ø¹Ø§Ø¦Ù… ÙˆØ£Ù†ÙŠÙ‚ */
        .card {
            border: none;
            border-radius: 18px; /* Ø­ÙˆØ§Ù Ø£ÙƒØ«Ø± Ø¯Ø§Ø¦Ø±ÙŠØ© */
            overflow: hidden;
            /* Ø¸Ù„ Ù†Ø§Ø¹Ù… ÙˆÙˆØ§Ø¶Ø­ */
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-4px); /* ØªØ£Ø«ÙŠØ± Ø±ÙØ¹ Ø£ÙƒØ¨Ø± */
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
        }

        /* Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„ÙƒØ§Ø±Ø¯ - Ø®Ù„ÙÙŠØ© Ø«Ø§Ø¨ØªØ© Ù„Ù„Ø£Ø²Ø±Ù‚ */
        .card-header {
            font-weight: 700;
            font-size: 1.15rem;
            color: white;
            /* Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙØ¦Ø© Ø¨ÙˆÙˆØªØ³ØªØ±Ø§Ø¨ Ù„ØªÙ…Ø«ÙŠÙ„ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø²Ø±Ù‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
            background-color: var(--primary-color) !important;
            padding: 1rem 1.5rem;
        }

        .card-header.bg-secondary {
            background-color: var(--primary-dark) !important; /* Ù„ÙˆÙ† Ø£ØºÙ…Ù‚ Ù„Ø³Ø¬Ù„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª */
        }

        .form-control, textarea {
            border-radius: 12px;
            border: 1px solid #ced4da;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            font-size: 1rem;
            padding: 0.75rem;
        }

        .form-control:focus, textarea:focus {
            /* Ø¥Ø·Ø§Ø± ØªØ±ÙƒÙŠØ² Ø£Ø²Ø±Ù‚ */
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25);
        }

        .btn {
            border-radius: 12px;
            font-weight: 700;
            transition: all 0.3s ease;
        }

        /* Ø²Ø± Ø§Ù„Ø­ÙØ¸ (Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ) */
        .btn-success {
            background-color: var(--primary-color) !important;
            border-color: var(--primary-color) !important;
        }

        .btn-success:hover {
            background-color: var(--primary-dark) !important;
            border-color: var(--primary-dark) !important;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.4);
        }

        /* Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© (Secondary/Outline) */
        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
            background-color: transparent;
        }

        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            color: white;
        }

        /* Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© (Secondary) */
        .btn-secondary {
            background-color: #e9ecef !important;
            color: var(--text-color-dark) !important;
            border-color: #e9ecef !important;
        }

        .btn-secondary:hover {
            background-color: #dee2e6 !important;
            border-color: #dee2e6 !important;
        }


        /* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© */
        .table th {
            /* Ø®Ù„ÙÙŠØ© Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø²Ø±Ù‚ Ø§Ù„Ø¯Ø§ÙƒÙ† */
            background: var(--primary-dark) !important;
            color: #fff;
            text-align: center;
            font-weight: 700;
        }

        .table td {
            background: #fff;
            font-size: 0.95rem;
            border-color: rgba(0, 0, 0, 0.08); /* Ø­Ø¯ÙˆØ¯ ÙØ§ØªØ­Ø© */
        }

        /* Multi-line text for previous visits */
        .multiline-text {
            white-space: pre-wrap;
            line-height: 1.8;
            background: var(--primary-light); /* Ø®Ù„ÙÙŠØ© ÙØ§ØªØ­Ø© Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ù‚ */
            border-radius: 10px;
            padding: 10px;
            font-size: 0.9rem;
            border: 1px solid rgba(0, 123, 255, 0.1);
        }

        textarea {
            line-height: 1.7;
        }

        /* ÙƒØ§Ø±Ø¯ Ø§Ù„Ø±ÙˆØ´ØªØ© */
        .prescription-card {
            background: linear-gradient(135deg, #f8faff 0%, #e6f3ff 100%);
            border: 2px solid #007BFF;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .prescription-item {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid #007BFF;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }

        .prescription-item h6 {
            color: #0056b3;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .prescription-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .prescription-detail {
            background: #f0f8ff;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            h2 {
                font-size: 1.6rem;
            }

            .card-header {
                font-size: 1rem;
            }

            .page-wrapper {
                margin-right: 0;
            }

            .btn {
                padding: 8px 15px;
                font-size: 0.95rem;
            }

            .form-control, textarea {
                font-size: 0.9rem;
            }

            .table {
                font-size: 0.8rem;
            }

            .table-responsive {
                overflow-x: auto;
            }

            .prescription-details {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .btn {
                width: 100%;
                margin-bottom: 8px;
            }
        }
    </style>
</head>

<body class="p-3">
<div th:replace="fragments/sidebar :: doctorSidebar()"></div>
<div th:replace="fragments/chat-popup :: chatPopupFragment"></div>

<div class="page-wrapper">

    <h2 class="mb-4 text-center">
        <i class="bi bi-heart-pulse-fill text-success"></i> Ø§Ù„ÙƒØ´Ù Ø§Ù„Ø¬Ø§Ø±ÙŠ
    </h2>

    <div class="card mb-4">
        <div class="card-header bg-primary text-white"><i class="bi bi-person-lines-fill"></i> Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶</div>
        <div class="card-body">
            <p><strong>Ø§Ù„Ø§Ø³Ù…:</strong> <span id="patientName" th:text="${patient.user.fullName}"></span></p>
            <p><strong>Ø§Ù„ÙƒÙˆØ¯:</strong> <span id="patientCode" th:text="${patient.patientCode}"></span></p>
            <p><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> <span id="patientPhone" th:text="${patient.user.phone}"></span></p>
        </div>
    </div>

    <form th:action="@{/doctor/visit/update}" method="post">
        <input type="hidden" name="visitId" th:value="${visit.id}"/>
        <input type="hidden" name="prescription" id="prescriptionJson" value=""/>

        <div class="card mb-4">
            <div class="card-header bg-primary text-white"><i class="bi bi-file-medical"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            </div>

            <div class="card-body">
                <p><strong>Ø§Ù„Ù†ÙˆØ¹:</strong> <span th:text="${visit.visitType}"></span></p>
                <p><strong>Ø§Ù„Ø´ÙƒÙˆÙ‰:</strong> <span th:text="${visit.complaint}"></span></p>
                <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong>
                    <span th:text="${#temporals.format(visit.visitDate, 'yyyy-MM-dd HH:mm')}"></span>
                </p>

                <div class="mt-3">
                    <label class="form-label fw-bold">Ø§Ù„ØªØ´Ø®ÙŠØµ</label>
                    <textarea id="diagnosisField" class="form-control" name="diagnosis" rows="4"
                              th:text="${visit.diagnosis}"></textarea>
                </div>

                <!-- ÙƒØ§Ø±Ø¯ Ø§Ù„Ø±ÙˆØ´ØªØ© -->
                <div class="card mb-4" id="prescriptionCard">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <!-- Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ø¨Ø§Ø¯Ø¬ Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ† -->
                        <div class="d-flex align-items-center gap-2">
                            <i class="bi bi-prescription2"></i> Ø§Ù„Ø±ÙˆØ´ØªØ© Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©
                            <span class="badge bg-light text-primary" id="prescriptionCount">0 Ø¯ÙˆØ§Ø¡</span>
                        </div>

                        <!-- Ø§Ù„Ø²Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø´Ù…Ø§Ù„ (Ø§Ù„ÙŠØ³Ø§Ø± ÙÙŠ RTL) -->
                        <button type="button" class="btn btn-light text-primary" id="openPrescriptionBtn">
                            <i class="bi bi-file-medical"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±ÙˆØ´ØªØ©
                        </button>
                    </div>

                    <div class="card-body">
                        <div id="prescriptionDisplay">
                            <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
                            <div class="text-center text-muted py-3">
                                <i class="bi bi-inbox fs-1"></i>
                                <p class="mt-2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¯ÙˆÙŠØ© Ù…Ø¶Ø§ÙØ© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</p>
                                <button type="button" class="btn btn-outline-primary mt-2"
                                        onclick="openPrescriptionPopup()">
                                    <i class="bi bi-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ø£Ø¯ÙˆÙŠØ©
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- â­ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ© -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <i class="bi bi-bag-plus"></i> Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
                    </div>
                    <div class="card-body">

                        <div class="row g-2 mb-3">
                            <div class="col-md-6">
                                <select id="serviceSelect" class="form-select">
<!--                                    <option th:each="c : ${services}"-->
<!--                                            th:value="${c.id}"-->
<!--                                            th:data-price="${c.price}"-->
<!--                                            th:text="${c.name}">-->
<!--                                    </option>-->
                                </select>

                            </div>

                            <div class="col-md-3">
                                <input type="number" id="servicePrice" class="form-control" placeholder="Ø§Ù„Ø³Ø¹Ø±" min="0" readonly>
                            </div>

                            <div class="col-md-3">
                                <button type="button" class="btn btn-primary" onclick="addServiceToVisit()">
                                    <i class="bi bi-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®Ø¯Ù…Ø©
                                </button>
                            </div>
                        </div>
                        <input type="hidden" id="totalServicesInput" name="servicesTotal">

                        <table class="table table-bordered text-center" id="visitServiceTable">
                            <thead>
                            <tr>
                                <th>Ø§Ù„Ø®Ø¯Ù…Ø©</th>
                                <th>Ø§Ù„Ø³Ø¹Ø±</th>
                                <th>Ø­Ø°Ù</th>
                            </tr>
                            </thead>
                            <tbody></tbody>

                            <tfoot>
                            <tr class="table-primary">
                                <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                <th id="totalServicePrice">0</th>
                                <th></th>
                            </tr>
                            </tfoot>
                        </table>


                    </div>
                </div>

                <div class="mt-3">
                    <label class="form-label fw-bold">Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</label>
                    <input type="datetime-local" class="form-control" name="scheduledConsultation"
                           th:value="${visit.scheduledConsultation != null ?
                            #temporals.format(visit.scheduledConsultation, 'yyyy-MM-dd''T''HH:mm') : ''}"/>
                </div>

                <div class="mt-4 text-center d-flex flex-wrap justify-content-center gap-2">
                    <button type="submit" class="btn btn-success px-4" onclick="preparePrescriptionData()">
                        <i class="bi bi-save"></i> Ø­ÙØ¸
                    </button>
                    <!--                    <button type="submit" class="btn btn-success px-4"><i class="bi bi-save"></i> Ø­ÙØ¸</button>-->
                    <button type="button" class="btn btn-outline-primary px-4" onclick="printPrescription()"><i
                            class="bi bi-printer"></i> Ø·Ø¨Ø§Ø¹Ø©
                    </button>
                    <button type="button" class="btn btn-success px-4" onclick="sendWhatsAppPrescription()"><i
                            class="bi bi-whatsapp"></i> ÙˆØ§ØªØ³Ø§Ø¨
                    </button>
                    <a href="#" onclick="history.back()" class="btn btn-secondary px-4"><i
                            class="bi bi-arrow-right"></i> Ø¹ÙˆØ¯Ø©</a>
                </div>
            </div>
        </div>
    </form>

    <div class="card mb-5">
        <div class="card-header bg-secondary text-white"><i class="bi bi-clock-history"></i> Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-striped align-middle">
                    <thead>
                    <tr>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>Ø§Ù„Ù†ÙˆØ¹</th>
                        <th>Ø§Ù„Ø´ÙƒÙˆÙ‰</th>
                        <th>Ø§Ù„ØªØ´Ø®ÙŠØµ</th>
                        <th>Ø§Ù„Ø¹Ù„Ø§Ø¬</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="v : ${previousVisits}">
                        <td class="text-center" th:text="${#temporals.format(v.visitDate, 'yyyy-MM-dd')}"></td>
                        <td class="text-center" th:text="${v.visitType}"></td>
                        <td th:text="${v.complaint}"></td>
                        <td>
                            <div class="multiline-text"
                                 th:utext="${#strings.replace(v.diagnosis, '\n', '<br/>')}"></div>
                        </td>
                        <td>
                            <div class="multiline-text prescription-display" th:data-prescription="${v.prescription}">
                                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript -->
                            </div>
                        </td>
                    </tr>

                    <tr th:if="${#lists.isEmpty(previousVisits)}">
                        <td colspan="5" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª Ø³Ø§Ø¨Ù‚Ø©</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Prescription Popup - Updated Design -->
<div id="prescriptionPopup" class="modal"
     style="display:none; position:fixed;top:0;left:0;width:100%;height:100%;background: rgba(0,0,0,0.6); z-index:1050;">
    <div class="modal-dialog modal-lg" style="margin:5% auto; max-width:900px;">
        <div class="modal-content" style="border-radius: 18px; overflow: hidden;">
            <div class="modal-header bg-primary text-white" style="padding: 1rem 1.5rem;">
                <h5 class="modal-title" style="font-weight: 700;">
                    <i class="bi bi-file-medical-fill"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±ÙˆØ´ØªØ© Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©
                </h5>
                <button type="button" class="btn-close btn-close-white" onclick="closePrescriptionPopup()"
                        style="box-shadow: none;"></button>
            </div>

            <div class="modal-body" style="padding: 1.5rem;">
                <!-- Prescription Items Table -->
                <div class="table-responsive mb-4">
                    <table class="table table-bordered align-middle text-center" id="prescriptionTable">
                        <thead class="table-primary" style="background-color: #007BFF !important; color: white;">
                        <tr>
                            <th style="font-weight: 700;">Ø§Ù„Ø¯ÙˆØ§Ø¡</th>
                            <th style="font-weight: 700;">Ø§Ù„Ø¬Ø±Ø¹Ø©</th>
                            <th style="font-weight: 700;">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Øª</th>
                            <th style="font-weight: 700;">Ø§Ù„Ù…Ø¯Ø©</th>
                            <th style="font-weight: 700;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                            <th style="font-weight: 700;">Ø­Ø°Ù</th>
                        </tr>
                        </thead>
                        <tbody id="prescriptionItemsBody">
                        <!-- Dynamic rows will be added here -->
                        </tbody>
                    </table>
                </div>

                <!-- Add Medicine Button -->
                <div class="text-center mb-4">
                    <button type="button" class="btn btn-success" onclick="addPrescriptionItem()"
                            style="border-radius: 12px; font-weight: 700; padding: 0.5rem 1.5rem;">
                        <i class="bi bi-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ§Ø¡ Ø¬Ø¯ÙŠØ¯
                    </button>
                </div>

                <!-- Templates Section -->
                <div class="card mb-4" style="border-radius: 12px; border: 1px solid #e0e0e0;">
                    <div class="card-header bg-light" style="font-weight: 600; color: #0056b3;">
                        <i class="bi bi-file-earmark-text"></i> Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ø¬Ø§Ù‡Ø²Ø©
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <select id="templateSelect" class="form-select" style="border-radius: 8px;">
                                    <option value="">Ø§Ø®ØªØ± Ù‚Ø§Ù„Ø¨Ù‹Ø§ Ø¬Ø§Ù‡Ø²Ù‹Ø§...</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-primary flex-fill" onclick="loadTemplate()"
                                            style="border-radius: 8px;">
                                        <i class="bi bi-download"></i> ØªØ­Ù…ÙŠÙ„
                                    </button>
                                    <button class="btn btn-outline-success flex-fill" onclick="saveTemplate()"
                                            style="border-radius: 8px;">
                                        <i class="bi bi-save"></i> Ø­ÙØ¸
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer" style="padding: 1rem 1.5rem; border-top: 1px solid #dee2e6;">
                <button type="button" class="btn btn-secondary" onclick="closePrescriptionPopup()"
                        style="border-radius: 12px; font-weight: 700; padding: 0.5rem 1.5rem;">
                    <i class="bi bi-x-circle"></i> Ø¥Ù„ØºØ§Ø¡
                </button>
                <button type="button" class="btn btn-success" onclick="savePrescription()"
                        style="border-radius: 12px; font-weight: 700; padding: 0.5rem 1.5rem;">
                    <i class="bi bi-check-circle"></i> Ø­ÙØ¸ Ø§Ù„Ø±ÙˆØ´ØªØ©
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // =======================================================
    // ğŸ—‚ï¸ Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© Global Variables
    // =======================================================
    let prescriptionItems = [];
    let visitServices = []; // Ù…ØµÙÙˆÙØ© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…Ø¶Ø§ÙØ© Ù„Ù„Ø²ÙŠØ§Ø±Ø©
    const visitId = [[${visit.id}]] ; // Ù…Ø¹Ø±Ù Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠ
    const currentUserId = [[${doctor != null ? doctor.id : 0}]]; // Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ø´Ø§Øª


    // =======================================================
    // ğŸš€ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø© (DOMContentLoaded) - Ø§Ù„Ù…ÙˆØ­Ø¯
    // =======================================================
    document.addEventListener('DOMContentLoaded', function () {
        // --- 1. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±ÙˆØ´ØªØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ---
        const currentPrescription = /*[[${visit.prescription}]]*/ null;
        if (currentPrescription && currentPrescription !== 'null' && currentPrescription.trim() !== '') {
            try {
                prescriptionItems = JSON.parse(currentPrescription);
                updatePrescriptionDisplay();
            } catch (e) {
                console.error('Error parsing prescription:', e);
            }
        }

        // --- 2. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© (Ù‡Ù†Ø§ ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ø¥Ø¶Ø§ÙØ©) ---
        loadDoctorServicesDropdown();
        loadVisitServices();

        // --- 3. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±ÙˆØ´ØªØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ÙˆØ¹Ø±Ø¶Ù‡Ø§ ---
        processStoredPrescriptions();

        // --- 4. ØªÙØ¹ÙŠÙ„ Ø²Ø± ÙØªØ­ Ø§Ù„Ø±ÙˆØ´ØªØ© ---
        document.getElementById('openPrescriptionBtn').addEventListener('click', () => {
            openPrescriptionPopup();
        });

        // --- 5. ØªØ´ØºÙŠÙ„ Ø§Ù„Ø´Ø§Øª (WebSockets) ---
        setupChatWebSocket();
    });

    // =======================================================
    // ğŸ“ Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±ÙˆØ´ØªØ© (Prescription)
    // =======================================================

    function openPrescriptionPopup() {
        document.getElementById('prescriptionPopup').style.display = 'block';
        loadTemplates();
        renderPrescriptionItems();
    }

    function closePrescriptionPopup() {
        document.getElementById('prescriptionPopup').style.display = 'none';
    }

    function addPrescriptionItem(item = {name: '', dose: '', times: '', duration: '', notes: ''}) {
        prescriptionItems.push(item);
        renderPrescriptionItems();
    }

    function renderPrescriptionItems() {
        const tbody = document.getElementById('prescriptionItemsBody');
        tbody.innerHTML = '';

        prescriptionItems.forEach((item, idx) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <input type="text" class="form-control" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡"
                           value="${item.name}"
                           onchange="prescriptionItems[${idx}].name = this.value"
                           style="border-radius: 8px;">
                </td>
                <td>
                    <input type="text" class="form-control" placeholder="Ù…Ø«Ø§Ù„: 500mg"
                           value="${item.dose}"
                           onchange="prescriptionItems[${idx}].dose = this.value"
                           style="border-radius: 8px;">
                </td>
                <td>
                    <input type="number" class="form-control" placeholder="3"
                           value="${item.times}"
                           onchange="prescriptionItems[${idx}].times = this.value"
                           style="border-radius: 8px;">
                </td>
                <td>
                    <input type="number" class="form-control" placeholder="5"
                           value="${item.duration}"
                           onchange="prescriptionItems[${idx}].duration = this.value"
                           style="border-radius: 8px;">
                </td>
                <td>
                    <input type="text" class="form-control" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª"
                           value="${item.notes}"
                           onchange="prescriptionItems[${idx}].notes = this.value"
                           style="border-radius: 8px;">
                </td>
                <td>
                    <button class="btn btn-danger btn-sm" onclick="removePrescriptionItem(${idx})" style="border-radius: 8px;">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });

        if (prescriptionItems.length === 0) {
            addPrescriptionItem();
        }
    }

    function removePrescriptionItem(idx) {
        prescriptionItems.splice(idx, 1);
        renderPrescriptionItems();
        updatePrescriptionDisplay();
    }

    function updatePrescriptionDisplay() {
        const container = document.getElementById('prescriptionDisplay');
        const countElement = document.getElementById('prescriptionCount');

        const activeItems = prescriptionItems.filter(item =>
            item.name || item.dose || item.times || item.duration
        );

        if (activeItems.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-3">
                    <i class="bi bi-inbox fs-1"></i>
                    <p class="mt-2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¯ÙˆÙŠØ© Ù…Ø¶Ø§ÙØ© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</p>
                    <button type="button" class="btn btn-outline-primary mt-2" onclick="openPrescriptionPopup()">
                        <i class="bi bi-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ø£Ø¯ÙˆÙŠØ©
                    </button>
                </div>
            `;
            countElement.textContent = '0 Ø¯ÙˆØ§Ø¡';
            return;
        }

        let html = '';
        activeItems.forEach((item, index) => {
            html += `
                <div class="prescription-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <h6 class="mb-0">
                            <i class="bi bi-capsule"></i> ${item.name || 'Ø¯ÙˆØ§Ø¡ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'}
                        </h6>
                        <span class="badge bg-primary">${index + 1}</span>
                    </div>

                    <div class="prescription-details">
                        ${item.dose ? `<div class="prescription-detail">
                            <strong>Ø§Ù„Ø¬Ø±Ø¹Ø©:</strong> ${item.dose}
                        </div>` : ''}

                        ${item.times ? `<div class="prescription-detail">
                            <strong>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Øª:</strong> ${item.times} Ù…Ø±Ø§Øª ÙŠÙˆÙ…ÙŠØ§Ù‹
                        </div>` : ''}

                        ${item.duration ? `<div class="prescription-detail">
                            <strong>Ø§Ù„Ù…Ø¯Ø©:</strong> ${item.duration} ÙŠÙˆÙ…
                        </div>` : ''}

                        ${item.notes ? `<div class="prescription-detail">
                            <strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${item.notes}
                        </div>` : ''}
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
        countElement.textContent = `${activeItems.length} Ø¯ÙˆØ§Ø¡`;
    }

    // ØªØ¬Ù‡ÙŠØ² Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±ÙˆØ´ØªØ© Ù‚Ø¨Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙÙˆØ±Ù…
    function preparePrescriptionData() {
        const cleanedItems = prescriptionItems.filter(item =>
            item.name || item.dose || item.times || item.duration
        );
        document.getElementById("prescriptionJson").value = JSON.stringify(cleanedItems);
    }

    // Ø¯ÙˆØ§Ù„ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ ÙˆØ§Ù„Ø­ÙØ¸ (ØªÙ… Ø§Ù„Ø¥Ø¨Ù‚Ø§Ø¡ Ø¹Ù„ÙŠÙ‡Ø§ ÙƒÙ…Ø§ Ù‡ÙŠ)

    async function loadTemplates() {
        try {
            const res = await fetch('/doctor/visit/templates');
            const data = await res.json();
            const select = document.getElementById('templateSelect');
            select.innerHTML = `<option value="">Ø§Ø®ØªØ± Ù‚Ø§Ù„Ø¨Ù‹Ø§ Ø¬Ø§Ù‡Ø²Ù‹Ø§...</option>`;
            data.forEach(t => {
                select.innerHTML += `<option value='${encodeURIComponent(JSON.stringify(t))}'>${t.name}</option>`;
            });
        } catch (error) {
            console.error('Error loading templates:', error);
        }
    }

    function loadTemplate() {
        const select = document.getElementById('templateSelect');
        const value = select.value;
        if (!value) {
            alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù‚Ø§Ù„Ø¨ Ø£ÙˆÙ„Ø§Ù‹');
            return;
        }

        try {
            const t = JSON.parse(decodeURIComponent(value));
            prescriptionItems = JSON.parse(t.content);
            renderPrescriptionItems();
            updatePrescriptionDisplay();
            alert('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
        } catch (error) {
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ù„Ø¨');
            console.error('Error loading template:', error);
        }
    }

    async function saveTemplate() {
        const name = prompt("Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ù„Ø¨:");
        if (!name) return;

        if (prescriptionItems.length === 0 || prescriptionItems.every(item =>
            !item.name && !item.dose && !item.times && !item.duration
        )) {
            alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ù‚Ø§Ù„Ø¨ ÙØ§Ø±Øº');
            return;
        }

        try {
            const content = JSON.stringify(prescriptionItems);
            await fetch('/doctor/visit/template/save?name=' + encodeURIComponent(name) + '&content=' + encodeURIComponent(content), {
                method: 'POST'
            });
            alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­");
            loadTemplates();
        } catch (error) {
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ù„Ø¨');
            console.error('Error saving template:', error);
        }
    }

    async function savePrescription() {
        if (prescriptionItems.length === 0 || prescriptionItems.every(item =>
            !item.name && !item.dose && !item.times && !item.duration
        )) {
            if (!confirm('Ø§Ù„Ø±ÙˆØ´ØªØ© ÙØ§Ø±ØºØ©ØŒ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­ÙØ¸Ù‡Ø§ Ø¹Ù„Ù‰ Ø£ÙŠ Ø­Ø§Ù„ØŸ')) {
                return;
            }
        }

        try {
            const content = JSON.stringify(prescriptionItems);

            await fetch('/doctor/visit/save-prescription?visitId=' + visitId + '&content=' + encodeURIComponent(content), {
                method: 'POST'
            });

            alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø±ÙˆØ´ØªØ© Ø¨Ù†Ø¬Ø§Ø­");
            updatePrescriptionDisplay();
            closePrescriptionPopup();

        } catch (error) {
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø±ÙˆØ´ØªØ©');
            console.error('Error saving prescription:', error);
        }
    }


    // =======================================================
    // ğŸ¥ Ø¯ÙˆØ§Ù„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© (Services) - Ø§Ù„Ù…ÙˆØ­Ø¯Ø© ÙˆØ§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø© Ù…Ù† Ø§Ù„Ù€ DB
    // =======================================================

    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø±Ø¨Ø· Ø­Ø¯Ø« Ø§Ù„ØªØºÙŠÙŠØ± (Change)
    function handleServiceChange() {
        const selected = this.options[this.selectedIndex];
        // ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø³Ø¹Ø± ÙŠØªÙ… Ù‚Ø±Ø§Ø¡ØªÙ‡ Ù…Ù† Ø§Ù„Ù€ data-price Ø§Ù„Ø°ÙŠ ØªÙ… Ù…Ù„Ø¤Ù‡ Ù…Ù† loadDoctorServicesDropdown
        const price = selected.getAttribute("data-price");
        // ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø­Ù‚Ù„ Ø§Ù„Ø³Ø¹Ø± Ù‚Ø§Ø¨Ù„Ø§Ù‹ Ù„Ù„ÙƒØªØ§Ø¨Ø© Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø³Ø¹Ø± (Ù„Ø¥Ø¶Ø§ÙØ© Ø³Ø¹Ø± ÙŠØ¯ÙˆÙŠ)
        const priceInput = document.getElementById("servicePrice");
        priceInput.value = price ? price : "";
        priceInput.readOnly = !!price; // ÙŠØ¬Ø¹Ù„Ù‡ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø³Ø¹Ø± Ù…Ø­Ø¯Ø¯
    }

    // (A) - ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
    async function loadDoctorServicesDropdown() {
        try {
            // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù€ Backend
            const res = await fetch("/doctor/visit/services");
            const data = await res.json();

            const select = document.getElementById("serviceSelect");

            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ø§Ù„Ù‚Ø¯Ø§Ù…Ù‰ Ù‚Ø¨Ù„ Ø±Ø¨Ø· Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯
            select.removeEventListener("change", handleServiceChange);
            select.innerHTML = `<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø®Ø¯Ù…Ø©...</option>`;

            // Ù…Ù„Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¬Ù„ÙˆØ¨Ø©
            data.forEach(s => {
                select.innerHTML += `<option value="${s.id}" data-price="${s.price}">${s.name}</option>`;
            });

            // Ø±Ø¨Ø· ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø®Ø¯Ù…Ø© Ø¨ØªØ¹Ø¨Ø¦Ø© Ø­Ù‚Ù„ Ø§Ù„Ø³Ø¹Ø±
            select.addEventListener("change", handleServiceChange);

        } catch (error) {
            console.error("Error loading doctor services dropdown:", error);
        }
    }

    // (B) - Ø¥Ø¶Ø§ÙØ© Ø®Ø¯Ù…Ø© (ØªØ±Ø³Ù„ Ù„Ù„Ù€ Backend Ø«Ù… ØªÙØ¹ÙŠØ¯ Ø§Ù„Ø¬Ù„Ø¨ ÙˆØ§Ù„Ø¹Ø±Ø¶)
    async function addServiceToVisit() {
        const serviceSelect = document.getElementById("serviceSelect");
        const priceInput = document.getElementById("servicePrice");

        const serviceId = serviceSelect.value;
        const price = priceInput.value;

        if (!serviceId || !price || isNaN(parseFloat(price))) {
            alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø®Ø¯Ù…Ø© ÙˆØªØ­Ø¯ÙŠØ¯ Ø³Ø¹Ø± ØµØ­ÙŠØ­!");
            return;
        }

        try {
            // 1. Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¨Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ù„ÙÙŠØ©
            const response = await fetch(`/doctor/visit/service/add?visitId=${visitId}&serviceId=${serviceId}&price=${price}`, {
                method: "POST"
            });

            if (response.ok) {
                // 2. Ø§Ù„Ù†Ø¬Ø§Ø­: Ø¥Ø¹Ø§Ø¯Ø© Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                await loadVisitServices();
                // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
                serviceSelect.value = "";
                priceInput.value = "";
            } else {
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®Ø¯Ù…Ø©. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø®Ø§Ø¯Ù….");
            }
        } catch (error) {
            console.error("Error adding service:", error);
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….");
        }
    }

    // (C) - Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…Ø¶Ø§ÙØ© (ÙŠØ¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
    async function loadVisitServices() {
        try {
            const res = await fetch(`/doctor/visit/service/list?visitId=${visitId}`);
            visitServices = await res.json();

            const tbody = document.querySelector("#visitServiceTable tbody");
            tbody.innerHTML = "";

            visitServices.forEach((vs) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${vs.service.name}</td>
                    <td>${parseFloat(vs.price).toFixed(2)}</td>
                    <td>
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeServiceFromVisit(${vs.id})" style="border-radius: 8px;">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            calculateTotal(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
        } catch (error) {
            console.error("Error loading visit services:", error);
            calculateTotal();
        }
    }

    // (D) - Ø­Ø°Ù Ø®Ø¯Ù…Ø© (ÙŠØ±Ø³Ù„ Ù„Ù„Ù€ Backend Ø«Ù… ÙŠÙØ¹ÙŠØ¯ Ø§Ù„Ø¬Ù„Ø¨ ÙˆØ§Ù„Ø¹Ø±Ø¶)
    async function removeServiceFromVisit(visitServiceId) {
        if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø¯Ù…Ø©ØŸ")) {
            return;
        }

        try {
            const response = await fetch(`/doctor/visit/service/delete?visitServiceId=${visitServiceId}`, {
                method: "POST"
            });

            if (response.ok) {
                await loadVisitServices();
            } else {
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø®Ø¯Ù…Ø©. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø®Ø§Ø¯Ù….");
            }
        } catch (error) {
            console.error("Error removing service:", error);
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….");
        }
    }

    // (E) - Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
    function calculateTotal() {
        const total = visitServices.reduce((sum, s) => sum + parseFloat(s.price), 0);
        document.getElementById("totalServicePrice").innerText = total.toFixed(2);
        document.getElementById("totalServicesInput").value = total.toFixed(2);
    }


    // =======================================================
    // ğŸ–¨ï¸ Ø¯ÙˆØ§Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙˆØ§Ù„ÙˆØ§ØªØ³Ø§Ø¨
    // =======================================================

    function printPrescription() {
        const patientName = document.getElementById('patientName').innerText.trim();
        const diagnosis = document.getElementById('diagnosisField').value.trim();
        const consultationDateInput = document.querySelector('input[name="scheduledConsultation"]').value;

        let formattedDate = '';
        if (consultationDateInput) {
            const dateObj = new Date(consultationDateInput);
            formattedDate = dateObj.toLocaleString('ar-EG', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        let prescriptionHtml = '';
        const activeItems = prescriptionItems.filter(item =>
            item.name || item.dose || item.times || item.duration
        );

        if (activeItems.length > 0) {
            prescriptionHtml = `
                <table class="table table-bordered mt-3" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background-color: #007BFF; color: white;">
                            <th style="padding: 10px; border: 1px solid #ddd;">Ø§Ù„Ø¯ÙˆØ§Ø¡</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">Ø§Ù„Ø¬Ø±Ø¹Ø©</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Øª</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">Ø§Ù„Ù…Ø¯Ø©</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody>`;

            activeItems.forEach((item) => {
                prescriptionHtml += `
                    <tr>
                        <td style="padding: 8px; border: 1px solid #ddd;">${item.name || ''}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${item.dose || ''}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${item.times || ''}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${item.duration || ''}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${item.notes || ''}</td>
                    </tr>`;
            });

            prescriptionHtml += `</tbody></table>`;
        } else {
            prescriptionHtml = '<div class="alert alert-info text-center mt-3">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¯ÙˆÙŠØ© Ù…Ø¶Ø§ÙØ©</div>';
        }

        const printWindow = window.open('', '_blank', 'width=800,height=600');

        printWindow.document.write(`
        <!DOCTYPE html>
        <html lang="ar" dir="rtl">
        <head>
            <meta charset="UTF-8">
            <title>ÙˆØµÙØ© Ø·Ø¨ÙŠØ©</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
            <style>
                body {
                    font-family: 'Tajawal', sans-serif;
                    padding: 40px;
                    line-height: 1.8;
                    background: #f8faff;
                }
                .content {
                    white-space: pre-wrap;
                    background:#E6F3FF;
                    padding: 20px;
                    border-radius: 10px;
                    border: 1px solid #007BFF;
                    margin-bottom: 20px;
                }
                h2, h5 {
                    color: #0056b3;
                    font-weight: 700;
                }
                .header {
                    text-align: center;
                    margin-bottom: 30px;
                    border-bottom: 2px solid #007BFF;
                    padding-bottom: 20px;
                }
                .footer {
                    text-align: center;
                    margin-top: 40px;
                    padding-top: 20px;
                    border-top: 1px solid #007BFF;
                    color: #007BFF;
                    font-weight: 600;
                }
                table {
                    width: 100%;
                    margin-top: 20px;
                    border-radius: 8px;
                    overflow: hidden;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                }
                th {
                    background-color: #007BFF !important;
                    color: white !important;
                    font-weight: 700 !important;
                }
                @media print {
                    body { padding: 20px; }
                    .no-print { display: none; }
                    .content { page-break-inside: avoid; }
                    table { page-break-inside: auto; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h2 class="mb-3"><i class="bi bi-file-medical"></i> ÙˆØµÙØ© Ø·Ø¨ÙŠØ©</h2>
                <h5>Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ø§Ù„Ø·Ø¨ÙŠØ©</h5>
            </div>

            <div class="patient-info">
                <h5><i class="bi bi-person"></i> Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶:</h5>
                <div class="content">${patientName}</div>

                <h5 class="mt-4"><i class="bi bi-clipboard-check"></i> Ø§Ù„ØªØ´Ø®ÙŠØµ:</h5>
                <div class="content">${diagnosis.replace(/\n/g, '<br>')}</div>

                <h5 class="mt-4"><i class="bi bi-capsule"></i> Ø§Ù„Ø¹Ù„Ø§Ø¬ Ø§Ù„Ù…ÙˆØµÙˆÙ:</h5>
                <div class="content">
                    ${prescriptionHtml}
                </div>

                ${formattedDate ? `
                <h5 class="mt-4"><i class="bi bi-calendar-check"></i> Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©:</h5>
                <div class="content">${formattedDate}</div>` : ''}
            </div>

            <div class="footer">
                <p>Ù†ØªÙ…Ù†Ù‰ Ù„ÙƒÙ… Ø§Ù„Ø´ÙØ§Ø¡ Ø§Ù„Ø¹Ø§Ø¬Ù„ ğŸŒ¿</p>
                <p>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ${new Date().toLocaleDateString('ar-EG')}</p>
                <button class="btn btn-primary no-print mt-3" onclick="window.print()">
                    <i class="bi bi-printer"></i> Ø·Ø¨Ø§Ø¹Ø©
                </button>
            </div>
        </body>
        </html>
        `);

        printWindow.document.close();
        setTimeout(() => {
            printWindow.print();
        }, 500);
    }

    async function sendWhatsAppPrescription() {
        try {
            const patientName = document.getElementById('patientName').innerText.trim();
            let patientPhone = document.getElementById('patientPhone').innerText.trim();
            const diagnosis = document.getElementById('diagnosisField').value.trim();
            const consultationDateInput = document.querySelector('input[name="scheduledConsultation"]').value;

            if (!patientPhone) {
                alert('Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø±ÙŠØ¶ ØºÙŠØ± Ù…ØªÙˆÙØ±');
                return;
            }

            patientPhone = patientPhone.replace(/\D/g, '');
            if (!patientPhone.startsWith("20")) {
                patientPhone = "20" + patientPhone;
            }

            let formattedDate = '';
            if (consultationDateInput) {
                const dateObj = new Date(consultationDateInput);
                formattedDate = dateObj.toLocaleString('ar-EG', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            let prescriptionText = '';
            const activeItems = prescriptionItems.filter(item =>
                item.name || item.dose || item.times || item.duration
            );

            if (activeItems.length > 0) {
                prescriptionText = 'Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ù…ÙˆØµÙˆÙØ©:\n';
                activeItems.forEach((item, index) => {
                    prescriptionText += `\n${index + 1}. ${item.name || 'Ø¯ÙˆØ§Ø¡'}\n`;
                    if (item.dose) prescriptionText += `   Ø§Ù„Ø¬Ø±Ø¹Ø©: ${item.dose}\n`;
                    if (item.times) prescriptionText += `   Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Øª: ${item.times} Ù…Ø±Ø§Øª ÙŠÙˆÙ…ÙŠØ§Ù‹\n`;
                    if (item.duration) prescriptionText += `   Ø§Ù„Ù…Ø¯Ø©: ${item.duration} ÙŠÙˆÙ…\n`;
                    if (item.notes) prescriptionText += `   Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${item.notes}\n`;
                });
            } else {
                prescriptionText = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¯ÙˆÙŠØ© Ù…Ø¶Ø§ÙØ©';
            }

            let message =
                `ğŸ¥ ÙˆØµÙØ© Ø·Ø¨ÙŠØ©\n\n` +
                `Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶: ${patientName}\n\n` +
                `Ø§Ù„ØªØ´Ø®ÙŠØµ:\n${diagnosis}\n\n` +
                `Ø§Ù„Ø¹Ù„Ø§Ø¬:\n${prescriptionText}\n\n` +
                (formattedDate ? `Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©: ${formattedDate}\n\n` : "") +
                `ØªÙ…Ù†ÙŠØ§ØªÙ†Ø§ Ø¨Ø§Ù„Ø´ÙØ§Ø¡ Ø§Ù„Ø¹Ø§Ø¬Ù„ ğŸŒ¿`;

            const whatsappUrl = `https://wa.me/${patientPhone}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');

        } catch (error) {
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙˆØµÙØ©. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
            console.error('Error sending WhatsApp:', error);
        }
    }

    // =======================================================
    // ğŸ•°ï¸ Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø±ÙˆØ´ØªØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    // =======================================================

    function processStoredPrescriptions() {
        const prescriptionElements = document.querySelectorAll('.prescription-display');

        prescriptionElements.forEach(element => {
            const prescriptionJson = element.getAttribute('data-prescription');
            if (prescriptionJson) {
                const formattedText = formatPrescriptionForDisplay(prescriptionJson);
                element.innerHTML = formattedText.replace(/\n/g, '<br>');
            }
        });
    }

    function formatPrescriptionForDisplay(prescriptionJson) {
        if (!prescriptionJson || prescriptionJson.trim() === '' || prescriptionJson === 'null') {
            return 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±ÙˆØ´ØªØ©';
        }

        try {
            const items = JSON.parse(prescriptionJson);
            if (!Array.isArray(items) || items.length === 0) {
                return 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¯ÙˆÙŠØ© Ù…Ø¶Ø§ÙØ©';
            }

            let formattedText = '';
            items.forEach((item, index) => {
                if (item.name || item.dose || item.times || item.duration) {
                    formattedText += `${index + 1}. ${item.name || 'Ø¯ÙˆØ§Ø¡'}\n`;

                    const details = [];
                    if (item.dose) details.push(`Ø§Ù„Ø¬Ø±Ø¹Ø©: ${item.dose}`);
                    if (item.times) details.push(`Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Øª: ${item.times} Ù…Ø±Ø§Øª ÙŠÙˆÙ…ÙŠØ§Ù‹`);
                    if (item.duration) details.push(`Ø§Ù„Ù…Ø¯Ø©: ${item.duration} ÙŠÙˆÙ…`);
                    if (item.notes) details.push(`Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${item.notes}`);

                    if (details.length > 0) {
                        formattedText += '   ' + details.join('ØŒ ') + '\n';
                    }
                    formattedText += '\n';
                }
            });

            return formattedText.trim();
        } catch (e) {
            console.error('Error parsing prescription:', e);
            return prescriptionJson;
        }
    }


    // =======================================================
    // ğŸ’¬ Ø¯ÙˆØ§Ù„ Ø§Ù„Ø´Ø§Øª (WebSocket)
    // =======================================================

    function setupChatWebSocket() {
        console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„Ø´Ø§Øª ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©...');

        let stompClient = null;
        let unreadCount = 0;

        function updateBadge(count) {
            unreadCount = count;
            const sidebarBadge = document.getElementById('sidebarChatBadge');
            if (!sidebarBadge) return;

            sidebarBadge.textContent = count > 99 ? '99+' : count;
            sidebarBadge.style.display = count > 0 ? "flex" : "none";
            if (count > 0) sidebarBadge.style.animation = 'pulse 2s infinite';
            localStorage.setItem('chatUnreadCount_' + currentUserId, count);
        }

        function loadUnreadCount() {
            const stored = localStorage.getItem('chatUnreadCount_' + currentUserId);
            updateBadge(stored ? parseInt(stored) : 0);
        }

        function connectWebSocket() {
            try {
                const socket = new SockJS('/ws');
                stompClient = Stomp.over(socket);
                stompClient.debug = null;

                stompClient.connect({}, function (frame) {
                    stompClient.subscribe('/user/' + currentUserId + '/queue/messages', function (message) {
                        try {
                            const msg = JSON.parse(message.body);
                            if (msg.senderId !== currentUserId) {
                                unreadCount++;
                                updateBadge(unreadCount);
                                playNotificationSound();
                            }
                        } catch (e) {
                            console.error(e);
                        }
                    });
                    loadUnreadCount();
                }, function (error) {
                    setTimeout(connectWebSocket, 5000);
                });
            } catch (error) {
                console.error(error);
            }
        }

        function playNotificationSound() {
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBzKF0fPTgjMGHm7A7+OZUQ0PVqzn77BdGAg+ltryxnYpBSuBzvLZiTYIGWa77+ifTRAMT6Ti8LZjHAY3kdnyzXksBSV3yPDdkEAKFF+16+usVRQLRp/h8r1sIAcyhdHz04IzBh9uwPDjmVAND1as5++wXRgIPpbb8sV2KQUrgdDy2Yk2CBlmvO/pn00QDE6k4/C2YxwGOJHa8s15LAUmeMnw3ZBADRRGU=');
                audio.volume = 0.3;
                audio.play().catch(e => {});
            } catch (e) {}
        }

        window.addEventListener('storage', function (event) {
            if (event.key === 'chatUnreadCount_' + currentUserId) {
                updateBadge(parseInt(event.newValue) || 0);
            }
        });

        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ·Ù„Ø¨ Ø§Ù„Ø¹Ø¯Ø¯ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        setTimeout(function () {
            connectWebSocket();
            fetch('/chat/unread-count')
                .then(res => res.json())
                .then(count => updateBadge(count))
                .catch(e => {});
        }, 500);
    }
</script>

</body>
</html>