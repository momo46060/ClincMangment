<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø§Ù„ÙƒØ´Ù Ø§Ù„Ø­Ø§Ù„ÙŠ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Ø¥Ø¶Ø§ÙØ© Ù…ÙƒØªØ¨Ø© jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        .multiline-text {
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.8;
        }

        .visit-table td {
            vertical-align: top;
        }

        textarea {
            line-height: 1.6;
        }

        /* Ø³ØªØ§ÙŠÙ„ Ù„Ù„Ø±ÙˆØ´ØªØ© Ø§Ù„Ù…Ø®ÙÙŠØ© Ø§Ù„ØªÙŠ Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ù„Ù€ PDF */
        #hiddenPrescription {
            position: absolute;
            left: -9999px;
            width: 800px;
            background: white;
            padding: 40px;
            font-family: Arial, sans-serif;
        }
    </style>
</head>
<body class="bg-light p-4">

<div class="container">
    <h2 class="mb-4 text-center">Ø§Ù„ÙƒØ´Ù Ø§Ù„Ø¬Ø§Ø±ÙŠ</h2>

    <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ -->
    <div class="card shadow mb-4">
        <div class="card-header bg-info text-white">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶</div>
        <div class="card-body">
            <p><strong>Ø§Ù„Ø§Ø³Ù…:</strong> <span id="patientName" th:text="${patient.user.fullName}"></span></p>
            <p><strong>Ø§Ù„ÙƒÙˆØ¯:</strong> <span id="patientCode" th:text="${patient.patientCode}"></span></p>
            <p><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> <span id="patientPhone" th:text="${patient.user.phone}"></span></p>
        </div>
    </div>

    <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© -->
    <form th:action="@{/doctor/visit/update}" method="post">
        <input type="hidden" name="visitId" th:value="${visit.id}"/>
        <div class="card shadow mb-4">
            <div class="card-header bg-primary text-white">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>
            <div class="card-body">
                <p><strong>Ø§Ù„Ù†ÙˆØ¹:</strong> <span th:text="${visit.visitType}"></span></p>
                <p><strong>Ø§Ù„Ø´ÙƒÙˆÙ‰:</strong> <span th:text="${visit.complaint}"></span></p>
                <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> <span
                        th:text="${#temporals.format(visit.visitDate, 'yyyy-MM-dd HH:mm')}"></span></p>

                <div class="mt-3">
                    <label class="form-label fw-bold">Ø§Ù„ØªØ´Ø®ÙŠØµ</label>
                    <textarea id="diagnosisField" class="form-control" name="diagnosis" rows="4"
                              th:text="${visit.diagnosis}"></textarea>
                    <small class="text-muted">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯</small>
                </div>

                <div class="mt-3">
                    <label class="form-label fw-bold">Ø§Ù„Ø¹Ù„Ø§Ø¬</label>
                    <textarea id="prescriptionField" class="form-control" name="prescription" rows="5"
                              th:text="${visit.prescription}"></textarea>
                    <small class="text-muted">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯</small>
                </div>

                <div class="mt-3">
                    <label class="form-label fw-bold">Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</label>
                    <input type="datetime-local" class="form-control" name="scheduledConsultation"
                           th:value="${visit.scheduledConsultation != null ? #temporals.format(visit.scheduledConsultation, 'yyyy-MM-dd''T''HH:mm') : ''}"/>
                </div>

                <div class="mt-4 text-center">
                    <button type="submit" class="btn btn-success px-4">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
                    <button type="button" class="btn btn-outline-primary px-4" onclick="printPrescription()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©
                        Ø§Ù„Ø¹Ù„Ø§Ø¬
                    </button>

                    <button type="button" class="btn btn-success px-4" onclick="sendWhatsAppPrescription()">
                        ğŸ“± Ø¥Ø±Ø³Ø§Ù„ Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨
                    </button>
                    <a href="#" onclick="history.back()" class="btn btn-secondary px-4">â¬…ï¸ Ø¹ÙˆØ¯Ø©</a>
                </div>
            </div>
        </div>
    </form>

    <!-- Ø³Ø¬Ù„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© -->
    <div class="card shadow">
        <div class="card-header bg-secondary text-white">Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-striped align-middle visit-table">
                    <thead class="table-dark text-center">
                    <tr>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>Ø§Ù„Ù†ÙˆØ¹</th>
                        <th>Ø§Ù„Ø´ÙƒÙˆÙ‰</th>
                        <th>Ø§Ù„ØªØ´Ø®ÙŠØµ</th>
                        <th>Ø§Ù„Ø¹Ù„Ø§Ø¬</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="v : ${previousVisits}">
                        <td class="text-center" th:text="${#temporals.format(v.visitDate, 'yyyy-MM-dd')}"></td>
                        <td class="text-center" th:text="${v.visitType}"></td>
                        <td th:text="${v.complaint}"></td>

                        <!-- Ø§Ù„ØªØ´Ø®ÙŠØµ ÙÙŠ Ø£ÙƒØ«Ø± Ù…Ù† Ø³Ø·Ø± -->
                        <td>
                            <div class="p-2 bg-light border rounded multiline-text"
                                 th:utext="${#strings.replace(v.diagnosis, '\n', '<br/>')}">
                            </div>

                        </td>
                        <!-- Ø§Ù„Ø¹Ù„Ø§Ø¬ ÙÙŠ Ø£ÙƒØ«Ø± Ù…Ù† Ø³Ø·Ø± -->
                        <td>
                            <div class="p-2 bg-light border rounded multiline-text"
                                 th:utext="${#strings.replace(v.prescription, '\n', '<br/>')}">
                            </div>
                        </td>
                    </tr>

                    <tr th:if="${#lists.isEmpty(previousVisits)}">
                        <td colspan="5" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª Ø³Ø§Ø¨Ù‚Ø©</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Ø¹Ù†ØµØ± Ù…Ø®ÙÙŠ Ù„ØªÙˆÙ„ÙŠØ¯ PDF -->
<div id="hiddenPrescription">
    <div style="text-align: center; border-bottom: 3px solid #0d6efd; padding-bottom: 20px; margin-bottom: 30px;">
        <h2>ğŸ¥ ÙˆØµÙØ© Ø·Ø¨ÙŠØ©</h2>
    </div>
    <div style="margin-bottom: 25px;">
        <div style="color: #0d6efd; font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #dee2e6; padding-bottom: 5px;">
            Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶
        </div>
        <div id="pdfPatientName" style="padding: 15px; background: #f8f9fa; border-radius: 5px;"></div>
    </div>
    <div style="margin-bottom: 25px;">
        <div style="color: #0d6efd; font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #dee2e6; padding-bottom: 5px;">
            Ø§Ù„ØªØ´Ø®ÙŠØµ
        </div>
        <div id="pdfDiagnosis"
             style="white-space: pre-wrap; padding: 15px; background: #f8f9fa; border-radius: 5px; line-height: 2;"></div>
    </div>
    <div style="margin-bottom: 25px;">
        <div style="color: #0d6efd; font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #dee2e6; padding-bottom: 5px;">
            Ø§Ù„Ø¹Ù„Ø§Ø¬
        </div>
        <div id="pdfPrescription"
             style="white-space: pre-wrap; padding: 15px; background: #f8f9fa; border-radius: 5px; line-height: 2;"></div>
    </div>
    <div id="pdfConsultationSection" style="margin-bottom: 25px; display: none;">
        <div style="color: #0d6efd; font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #dee2e6; padding-bottom: 5px;">
            Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©
        </div>
        <div id="pdfConsultation" style="padding: 15px; background: #f8f9fa; border-radius: 5px;"></div>
    </div>
    <div style="text-align: center; margin-top: 40px; color: #6c757d;">
        <p>ØªÙ…Ù†ÙŠØ§ØªÙ†Ø§ Ø¨Ø§Ù„Ø´ÙØ§Ø¡ Ø§Ù„Ø¹Ø§Ø¬Ù„ ğŸŒ¿</p>
    </div>
</div>

<script>

    function printPrescription() {
        const patientName = document.getElementById('patientName').innerText.trim();
        const diagnosis = document.getElementById('diagnosisField').value.trim();
        const prescription = document.getElementById('prescriptionField').value.trim();
        const consultationDateInput = document.querySelector('input[name="scheduledConsultation"]').value;

        let formattedDate = '';
        if (consultationDateInput) {
            const dateObj = new Date(consultationDateInput);
            formattedDate = dateObj.toLocaleString('ar-EG', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        const printWindow = window.open('', '_blank', 'width=800,height=600');
        printWindow.document.write(`
        <!DOCTYPE html>
        <html lang="ar" dir="rtl">
        <head>
            <meta charset="UTF-8">
            <title>ÙˆØµÙØ© Ø¹Ù„Ø§Ø¬ÙŠØ©</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
            <style>
                body {
                    font-family: 'Arial', sans-serif;
                    padding: 40px;
                    line-height: 2;
                }
                .header {
                    text-align: center;
                    border-bottom: 3px solid #0d6efd;
                    padding-bottom: 20px;
                    margin-bottom: 30px;
                }
                .section {
                    margin-bottom: 25px;
                }
                .section-title {
                    color: #0d6efd;
                    font-weight: bold;
                    margin-bottom: 10px;
                    border-bottom: 1px solid #dee2e6;
                    padding-bottom: 5px;
                }
                .content {
                    white-space: pre-wrap;
                    padding: 15px;
                    background: #f8f9fa;
                    border-radius: 5px;
                }
                .footer {
                    text-align: center;
                    margin-top: 40px;
                    color: #6c757d;
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h2>ğŸ¥ ÙˆØµÙØ© Ø·Ø¨ÙŠØ©</h2>
            </div>

            <div class="section">
                <div class="section-title">Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶</div>
                <div class="content">${patientName}</div>
            </div>

            <div class="section">
                <div class="section-title">Ø§Ù„ØªØ´Ø®ÙŠØµ</div>
                <div class="content">${diagnosis.replace(/\n/g, '<br>')}</div>
            </div>

            <div class="section">
                <div class="section-title">Ø§Ù„Ø¹Ù„Ø§Ø¬</div>
                <div class="content">${prescription.replace(/\n/g, '<br>')}</div>
            </div>

            ${formattedDate ? `
            <div class="section">
                <div class="section-title">Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</div>
                <div class="content">${formattedDate}</div>
            </div>
            ` : ''}

            <div class="footer">
                <p>ØªÙ…Ù†ÙŠØ§ØªÙ†Ø§ Ø¨Ø§Ù„Ø´ÙØ§Ø¡ Ø§Ù„Ø¹Ø§Ø¬Ù„ ğŸŒ¿</p>
            </div>
        </body>
        </html>
        `);
        printWindow.document.close();
        printWindow.print();
    }

    async function sendWhatsAppPrescription() {
        try {
            const patientName = document.getElementById('patientName').innerText.trim();
            let patientPhone = document.getElementById('patientPhone').innerText.trim();
            const diagnosis = document.getElementById('diagnosisField').value.trim();
            const prescription = document.getElementById('prescriptionField').value.trim();
            const consultationDateInput = document.querySelector('input[name="scheduledConsultation"]').value;

            if (!patientPhone) {
                alert('Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø±ÙŠØ¶ ØºÙŠØ± Ù…ØªÙˆÙØ±');
                return;
            }

            // Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¯ Ø§Ù„Ø¯ÙˆÙ„Ø© Ù…ØµØ± +20 Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯
            patientPhone = patientPhone.replace(/\D/g, ''); // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ø±Ù…ÙˆØ² Ø£Ùˆ Ù…Ø³Ø§ÙØ§Øª
            if (!patientPhone.startsWith("20")) {
                patientPhone = "20" + patientPhone;
            }

            // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®
            let formattedDate = '';
            if (consultationDateInput) {
                const dateObj = new Date(consultationDateInput);
                formattedDate = dateObj.toLocaleString('ar-EG', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            // Ø¥Ø¹Ø¯Ø§Ø¯ Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
            let message = `ğŸ¥ ÙˆØµÙØ© Ø·Ø¨ÙŠØ©\n\n`;
            message += `Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶: ${patientName}\n`;
            message += `Ø§Ù„ØªØ´Ø®ÙŠØµ:\n${diagnosis}\n\n`;
            message += `Ø§Ù„Ø¹Ù„Ø§Ø¬:\n${prescription}\n\n`;
            if (formattedDate) {
                message += `Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©: ${formattedDate}\n`;
            }
            message += `ØªÙ…Ù†ÙŠØ§ØªÙ†Ø§ Ø¨Ø§Ù„Ø´ÙØ§Ø¡ Ø§Ù„Ø¹Ø§Ø¬Ù„ ğŸŒ¿`;

            // ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Web Ù…Ø¨Ø§Ø´Ø±Ø©
            const whatsappUrl = `https://wa.me/${patientPhone}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');

        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±ÙˆØ´ØªØ©:', error);
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±ÙˆØ´ØªØ©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
        }
    }
</script>
</body>
</html>