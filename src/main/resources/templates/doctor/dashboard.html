<!DOCTYPE html>
<html lang="ar" dir="rtl" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø·Ø¨ÙŠØ¨</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #007BFF;
            --primary-dark: #0056b3;
            --primary-light: #E6F3FF;
            --text-color-dark: #212529;
        }

        .page-wrapper {
            margin-right: 260px;
            padding: 20px;
        }
        body {
            background: #f8faff;
            font-family: 'Tajawal', sans-serif;
            color: var(--text-color-dark);
        }

        h2 {
            font-weight: 800;
            color: var(--primary-dark);
            font-size: 2rem;
        }

        .card {
            border: none;
            border-radius: 18px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .stat-card {
            text-align: center;
            padding: 25px;
            color: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            font-weight: 700;
        }

        .bg-done { background: linear-gradient(135deg, var(--primary-color), #00BFFF); }
        .bg-current { background: linear-gradient(135deg, #f9a825, #fbc02d); }
        .bg-pending { background: linear-gradient(135deg, #495057, #6c757d); }
        .bg-canceled { background: linear-gradient(135deg, #e53935, #ef5350); }

        .stat-card h6 { font-size: 1rem; }
        .stat-card h3 {
            font-size: 2.2rem;
            font-weight: 900;
            margin-top: 5px;
        }

        .card-header {
            border-top-left-radius: 18px;
            border-top-right-radius: 18px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: #fff;
            padding: 1.2rem;
            font-size: 1.1rem;
        }

        table thead {
            background: var(--primary-dark);
            color: #fff;
            font-weight: 700;
        }

        .btn-primary, .btn-success {
            border-radius: 12px;
            font-weight: 700;
            padding: 8px 15px;
            transition: all 0.3s ease;
        }

        .btn-success {
            background-color: var(--primary-color) !important;
            border-color: var(--primary-color) !important;
        }
        .btn-success:hover {
            background-color: var(--primary-dark) !important;
            border-color: var(--primary-dark) !important;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);
        }

        .alert-primary {
            background-color: var(--primary-dark);
            color: white;
            border-radius: 15px;
            font-weight: 700;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }

        @media (max-width: 768px) {
            .stat-card {
                padding: 20px 10px;
            }
            .stat-card h3 {
                font-size: 2rem;
            }
            h2 {
                font-size: 1.6rem;
                text-align: center;
            }
            .page-wrapper {
                margin-right: 0;
                padding: 10px;
            }
        }
    </style>
</head>

<body class="p-2">

<div th:if="${subscriptionExpired}" class="modal fade show" style="display:block;">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center">
            <div class="modal-header">
                <h5 class="modal-title text-danger"><i class="bi bi-exclamation-triangle"></i> Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</h5>
            </div>
            <div class="modal-body">
                âš ï¸ Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ø§Ù†ØªÙ‡Ù‰. ÙŠØ±Ø¬Ù‰ ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù….
            </div>
        </div>
    </div>
</div>

<div th:replace="fragments/sidebar :: doctorSidebar()"></div>
<div th:replace="fragments/chat-popup :: chatPopupFragment"></div>

<div class="page-wrapper">

    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
        <h2 class="mb-2">Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¯ÙƒØªÙˆØ± <span th:text="${doctor.fullName}"></span> ğŸ‘‹</h2>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-6 col-md-3">
            <div class="stat-card bg-done shadow-sm">
                <h6>âœ“ ØªÙ… Ø§Ù„ÙƒØ´Ù</h6>
                <h3 th:text="${doneCount}">0</h3>
            </div>
        </div>

        <div class="col-6 col-md-3">
            <div class="stat-card bg-current shadow-sm">
                <h6>ğŸ•“ Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙƒØ´Ù</h6>
                <h3 th:text="${currentCount}">0</h3>
            </div>
        </div>

        <div class="col-6 col-md-3">
            <div class="stat-card bg-pending shadow-sm">
                <h6>âŒ› Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</h6>
                <h3 th:text="${pendingCount}">0</h3>
            </div>
        </div>

        <div class="col-6 col-md-3">
            <div class="stat-card bg-canceled shadow-sm">
                <h6>âŒ Ù…Ù„ØºØ§Ø©</h6>
                <h3 th:text="${canceledCount}">0</h3>
            </div>
        </div>
    </div>

    <div class="alert alert-primary text-center fw-bold">
        Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª: <span th:text="${totalCount}"></span>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header">
            <strong><i class="bi bi-clipboard2-pulse"></i> Ø§Ù„ÙƒØ´ÙˆÙØ§Øª Ø§Ù„Ø¬Ø§Ø±ÙŠØ©</strong>
        </div>

        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle shadow-sm">
                    <thead>
                    <tr>
                        <th>Ø§Ù„Ù…Ø±ÙŠØ¶</th>
                        <th>Ø§Ù„Ù†ÙˆØ¹</th>
                        <th>Ø§Ù„Ø´ÙƒÙˆÙ‰</th>
                        <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø²ÙŠØ§Ø±Ø©</th>
                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="v : ${currentVisits}">
                        <td th:text="${v.patient.user.fullName}"></td>
                        <td th:text="${v.visitType}"></td>
                        <td th:text="${v.complaint}"></td>
                        <td th:text="${#temporals.format(v.visitDate, 'yyyy-MM-dd HH:mm')}"></td>
                        <td>
                            <a th:href="@{'/doctor/visit/' + ${v.id}}" class="btn btn-success btn-sm">
                                <i class="bi bi-eye"></i> Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ´Ù
                            </a>
                        </td>
                    </tr>

                    <tr th:if="${#lists.isEmpty(currentVisits)}">
                        <td colspan="5" class="text-center text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒØ´Ù Ø¬Ø§Ø±Ù Ø§Ù„Ø¢Ù†</td>
                    </tr>

                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<!-- âœ… Ø§Ù„Ø³ÙƒØ±ÙŠØ¨ØªØ§Øª ÙÙŠ Ø¢Ø®Ø± Ø§Ù„ØµÙØ­Ø© (Ù‚Ø¨Ù„ </body>) -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<script th:inline="javascript">
    console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„Ø´Ø§Øª...');

    // =====================================================
    // CHAT WEBSOCKET WITH DEBUGGING
    // =====================================================
    (function() {
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª
        if (typeof SockJS === 'undefined') {
            console.error('âŒ SockJS Ù…Ø´ Ù…Ø­Ù…Ù‘Ù„!');
            return;
        }
        if (typeof Stomp === 'undefined') {
            console.error('âŒ Stomp Ù…Ø´ Ù…Ø­Ù…Ù‘Ù„!');
            return;
        }

        const currentUserId = /*[[${doctor.id}]]*/ 0;
        console.log('ğŸ‘¤ User ID:', currentUserId);

        const sidebarBadge = document.getElementById('sidebarChatBadge');

        if (!sidebarBadge) {
            console.error('âŒ Ø§Ù„Ø¨Ø§Ø¯Ø¬ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯! ID Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: sidebarChatBadge');
            console.log('ğŸ” Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£ÙŠ badge...');
            const allBadges = document.querySelectorAll('[id*="badge" i], [class*="badge" i]');
            console.log('ÙˆØ¬Ø¯Øª Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù†Ø§ØµØ±:', allBadges);
            return;
        }

        console.log('âœ… Ø§Ù„Ø¨Ø§Ø¯Ø¬ Ù…ÙˆØ¬ÙˆØ¯:', sidebarBadge);

        let stompClient = null;
        let unreadCount = 0;

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø§Ø¯Ø¬
        function updateBadge(count) {
            console.log('ğŸ“Š ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø§Ø¯Ø¬ Ù„Ù„Ø¹Ø¯Ø¯:', count);
            unreadCount = count;

            sidebarBadge.textContent = count > 99 ? '99+' : count;
            sidebarBadge.style.display = count > 0 ? "flex" : "none";

            if (count > 0) {
                sidebarBadge.style.animation = 'pulse 2s infinite';
            }

            // Ø­ÙØ¸ ÙÙŠ localStorage
            localStorage.setItem('chatUnreadCount_' + currentUserId, count);
        }

        // Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ø¯Ø¯ Ù…Ù† localStorage
        function loadUnreadCount() {
            const stored = localStorage.getItem('chatUnreadCount_' + currentUserId);
            const count = stored ? parseInt(stored) : 0;
            console.log('ğŸ’¾ ØªØ­Ù…ÙŠÙ„ Ù…Ù† localStorage:', count);
            updateBadge(count);
        }

        // WebSocket Connection
        function connectWebSocket() {
            console.log('ğŸ”Œ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ WebSocket...');

            try {
                const socket = new SockJS('/ws');
                stompClient = Stomp.over(socket);
                stompClient.debug = function(str) {
                    console.log('STOMP:', str);
                };

                stompClient.connect({}, function(frame) {
                    console.log('âœ… Ù…ØªØµÙ„ Ø¨Ù†Ø¬Ø§Ø­!', frame);

                    const subscription = '/user/' + currentUserId + '/queue/messages';
                    console.log('ğŸ“¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ:', subscription);

                    stompClient.subscribe(subscription, function(message) {
                        console.log('ğŸ“¨ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙˆØµÙ„Øª!', message);

                        try {
                            const msg = JSON.parse(message.body);
                            console.log('ğŸ“§ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', msg);

                            if (msg.senderId !== currentUserId) {
                                unreadCount++;
                                console.log('ğŸ”” Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©! Ø§Ù„Ø¹Ø¯Ø¯:', unreadCount);
                                updateBadge(unreadCount);
                                playNotificationSound();
                            }
                        } catch (e) {
                            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', e);
                        }
                    });

                    loadUnreadCount();

                }, function(error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„:', error);
                    setTimeout(connectWebSocket, 5000);
                });

            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„:', error);
            }
        }

        function playNotificationSound() {
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBzKF0fPTgjMGHm7A7+OZUQ0PVqzn77BdGAg+ltryxnYpBSuBzvLZiTYIGWa77+ifTRAMT6Ti8LZjHAY3kdnyzXksBSV3yPDdkEAKFF+16+usVRQLRp/h8r1sIAcyhdHz04IzBh9uwPDjmVAND1as5++wXRgIPpbb8sV2KQUrgdDy2Yk2CBlmvO/pn00QDE6k4/C2YxwGOJHa8s15LAUmeMnw3ZBADRRGU=');
                audio.volume = 0.3;
                audio.play().catch(e => console.log('âš ï¸ ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª'));
            } catch (e) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØµÙˆØª:', e);
            }
        }

        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ù…Ù† localStorage
        window.addEventListener('storage', function(event) {
            if (event.key === 'chatUnreadCount_' + currentUserId) {
                const newCount = parseInt(event.newValue) || 0;
                console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ù…Ù† tab Ø¢Ø®Ø±:', newCount);
                updateBadge(newCount);
            }
        });

        // Ø¨Ø¯Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('load', function() {
            console.log('ğŸ¬ Ø§Ù„ØµÙØ­Ø© Ø§ØªØ­Ù…Ù„ØªØŒ Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©...');

            // Ø§Ù†ØªØ¸Ø± Ø´ÙˆÙŠØ© Ù„Ù„ØªØ£ÙƒØ¯ Ø¥Ù† ÙƒÙ„ Ø­Ø§Ø¬Ø© Ø§ØªØ­Ù…Ù„Øª
            setTimeout(function() {
                connectWebSocket();

                // Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ø¯Ø¯ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
                console.log('ğŸ“ Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ø¯Ø¯ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±...');
                fetch('/chat/unread-count')
                    .then(res => {
                        console.log('ğŸ“¥ Ø±Ø¯ Ø§Ù„Ø³ÙŠØ±ÙØ±:', res.status);
                        return res.json();
                    })
                    .then(count => {
                        console.log('ğŸ“Š Ø§Ù„Ø¹Ø¯Ø¯ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±:', count);
                        updateBadge(count);
                    })
                    .catch(e => {
                        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ø¯Ø¯:', e);
                    });
            }, 500);
        });

        // Ø¯ÙˆØ§Ù„ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
        window.updateChatBadge = updateBadge;
        window.testChatBadge = function(count) {
            console.log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¨Ø§Ø¯Ø¬ Ø¨Ø§Ù„Ø¹Ø¯Ø¯:', count);
            updateBadge(count);
        };

        console.log('âœ… Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª Ø¬Ø§Ù‡Ø²! Ø¬Ø±Ø¨: testChatBadge(5)');

    })();
</script>

</body>
</html>