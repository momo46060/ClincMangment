<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8"/>
    <title>التقارير المالية</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet"/>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">

    <style>
        /*
         * ======================================
         * تخصيص الستايل للأزرق الطبي الفاخر (Medical Blue Financial Report)
         * ======================================
         */
        :root {
            --primary-color: #007BFF; /* أزرق موثوق للتركيز */
            --primary-dark: #0056b3;  /* للعناوين ورؤوس الجداول */
            --primary-light-hover: #e9f4ff; /* لون أفتح للتمرير/الخلفيات الخفيفة */
            --text-color-dark: #212529;
            --expense-color: #e53935; /* الأحمر للمصروفات (التباين) */
        }

        body {
            /* خلفية بيضاء مزرقة نظيفة */
            background: #f8faff;
            font-family: 'Tajawal', sans-serif;
            color: var(--text-color-dark);
        }

        /* Header */
        .financial-header {
            padding: 1.5rem;
            /* تدرج أزرق موحد */
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            border-radius: 20px;
            color: #fff;
            margin-bottom: 2rem;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }

        .financial-header h3 {
            font-size: 1.8rem;
            font-weight: 800;
        }


        /* Cards */
        .stat-card {
            border-radius: 20px;
            padding: 1.5rem;
            background: #fff;
            text-align: center;
            /* ظل أكثر وضوحاً وأناقة */
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            transition: .3s;
            border: none;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }

        .stat-card h6 {
            /* عناوين البطاقات بالأزرق الداكن */
            color: var(--primary-dark);
            font-weight: 700;
            font-size: 1.1rem;
        }

        .stat-card h4 {
            font-size: 2rem;
            font-weight: 900;
            margin-top: 5px;
        }

        /* Section Card */
        .section-card {
            border-radius: 20px;
            padding: 1.5rem;
            background: #fff;
            /* ظل أكثر وضوحاً وأناقة */
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 1.5rem;
            border: none;
        }

        .section-card h6 {
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        /* Chart responsive */
        .chart-container {
            height: 350px;
            width: 100%;
        }

        /* List items */
        ul li {
            /* خلفية زرقاء فاتحة لعناصر القائمة */
            background: var(--primary-light-hover);
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color-dark);
            list-style: none; /* إزالة التنقيط الافتراضي */
        }

        /* Date Filters and Buttons */
        .form-label {
            font-weight: 600;
            color: var(--text-color-dark);
        }

        .form-control {
            border-radius: 10px;
        }

        .btn-success {
            /* زر العرض باللون الأزرق الموحد */
            background-color: var(--primary-color) !important;
            border-color: var(--primary-color) !important;
            font-weight: 700;
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        .btn-success:hover {
            background-color: var(--primary-dark) !important;
            border-color: var(--primary-dark) !important;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);
        }

        /* Quick Links */
        .btn-outline-success {
            color: var(--primary-color);
            border-color: var(--primary-color);
            font-weight: 700;
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        .btn-outline-success:hover {
            background-color: var(--primary-color);
            color: white;
        }

        /* زر الصفحة الرئيسية */
        .btn-light {
            font-weight: 700 !important;
            border-radius: 12px;
            color: var(--primary-dark) !important;
            transition: all 0.3s ease;
        }
        .btn-light:hover {
            background-color: #e9ecef !important;
            transform: translateY(-1px);
        }


        @media (max-width: 767px) {

            .financial-header {
                flex-direction: column !important;
                text-align: center;
                padding: 1rem;
                margin-bottom: 1.5rem;
                border-radius: 15px;
            }

            .financial-header h3 {
                margin-bottom: 10px;
                font-size: 1.5rem;
            }

            .stat-card h4 {
                font-size: 1.6rem;
            }

            .stat-card h6 {
                font-size: 1rem;
            }

            .section-card {
                padding: 1.2rem;
                border-radius: 15px;
            }

            .chart-container {
                height: 250px;
            }

            ul li {
                font-size: .9rem;
            }
        }
    </style>
</head>

<body>
<div class="container py-4">

    <div class="financial-header d-flex justify-content-between align-items-center flex-wrap">
        <h3 th:text="${clinic.name} + ' - التقارير المالية'">التقارير المالية</h3>
        <a th:href="@{|/doctor/dashboard|}" class="btn btn-light fw-bold mt-2 mt-md-0">
            <i class="bi bi-house-door"></i> الصفحه الرئيسيه
        </a>
    </div>

    <div class="mb-4">
        <form method="get" th:action="@{/clinics/financial}" class="row g-3 align-items-end">
            <div class="col-md-3 col-sm-6">
                <label class="form-label">من</label>
                <input type="text" name="from" class="form-control date-picker" th:value="${fromDate}" readonly/>
            </div>
            <div class="col-md-3 col-sm-6">
                <label class="form-label">إلى</label>
                <input type="text" name="to" class="form-control date-picker" th:value="${toDate}" readonly/>
            </div>
            <div class="col-md-2 col-sm-6 d-grid">
                <button class="btn btn-success">عرض</button>
            </div>
        </form>
    </div>

    <div class="row g-4">
        <div class="col-md-4 col-sm-12">
            <div class="stat-card">
                <h6>إجمالي الإيراد (الفترة)</h6>
                <h4 th:text="${summary.revenuePeriod}">0</h4>
            </div>
        </div>
        <div class="col-md-4 col-sm-12">
            <div class="stat-card">
                <h6>إجمالي المصروفات</h6>
                <h4 th:text="${summary.expensePeriod}">0</h4>
            </div>
        </div>
        <div class="col-md-4 col-sm-12">
            <div class="stat-card">
                <h6>صافي الربح</h6>
                <h4 th:text="${summary.profit}">0</h4>
            </div>
        </div>
    </div>

    <div class="row mt-4 g-4">

        <div class="col-lg-8 col-12">
            <div class="section-card chart-container mb-4">
                <h6>الإيرادات والمصروفات (آخر 30 يوم)</h6>
                <canvas id="revExp30"></canvas>
            </div>

            <div class="section-card chart-container">
                <h6>إيرادات/مصروفات آخر 12 شهر</h6>
                <canvas id="revExp12"></canvas>
            </div>
        </div>

        <div class="col-lg-4 col-12">

            <div class="section-card mb-4">
                <h6>تفصيل المصروفات (آخر 90 يوم)</h6>
                <ul class="p-0 m-0">
                    <li th:each="entry : ${summary.expenseBreakdown.entrySet()}"
                        th:text="${entry.key + ' — ' + entry.value}">
                    </li>
                </ul>
            </div>

            <div class="section-card">
                <h6>روابط سريعة</h6>
                <a th:href="@{|/clinics/expenses/add|}" class="btn btn-outline-primary w-100 mb-3">
                    <i class="bi bi-cash-stack"></i> أضف مصروف جديد
                </a>
                <a th:href="@{|/clinics/expenses|}" class="btn btn-outline-primary w-100">
                    <i class="bi bi-list-columns"></i> عرض قائمة المصروفات
                </a>
            </div>
        </div>

    </div>

</div>

<script th:inline="javascript">
    /*<![CDATA[*/

    // الألوان الجديدة
    const revenueColor = '#007BFF'; // الأزرق
    const expenseColor = '#e53935'; // الأحمر

    const rv30 = [[${summary.revenueVsExpenseLast30Days}]];
    const labels30 = rv30.map(i => i.dateLabel);
    const rev30 = rv30.map(i => i.revenue);
    const exp30 = rv30.map(i => i.expense);

    new Chart(document.getElementById('revExp30'), {
        type: 'bar',
        data: {
            labels: labels30,
            datasets: [
                // تغيير لون الإيرادات إلى الأزرق
                {label: 'إيرادات', data: rev30, backgroundColor: revenueColor},
                {label: 'مصروفات', data: exp30, backgroundColor: expenseColor}
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    rtl: true,
                    position: 'top',
                    labels: { usePointStyle: true, boxWidth: 8, font: { family: 'Tajawal', size: 14 } }
                }
            },
            scales: {
                x: { ticks: { font: { family: 'Tajawal' } } },
                y: { ticks: { font: { family: 'Tajawal' } } }
            }
        }
    });

    const rev12 = [[${summary.revenueLast12Months}]];
    const exp12 = [[${summary.expensesLast12Months}]];

    const monthLabels = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 'يوليو',
        'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];

    new Chart(document.getElementById('revExp12'), {
        type: 'line',
        data: {
            labels: monthLabels,
            datasets: [
                // تغيير لون الإيرادات إلى الأزرق
                {label: 'إيرادات', data: rev12, borderColor: revenueColor, tension: 0.4, fill: true, backgroundColor: 'rgba(0, 123, 255, 0.1)'},
                {label: 'مصروفات', data: exp12, borderColor: expenseColor, tension: 0.4, fill: true, backgroundColor: 'rgba(229, 57, 53, 0.1)'}
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    rtl: true,
                    position: 'top',
                    labels: { usePointStyle: true, boxWidth: 8, font: { family: 'Tajawal', size: 14 } }
                }
            },
            scales: {
                x: { ticks: { font: { family: 'Tajawal' } } },
                y: { ticks: { font: { family: 'Tajawal' } } }
            }
        }
    });

    flatpickr(".date-picker", {
        dateFormat: "Y-m-d",
        locale: "ar"
    });

    /*]]>*/
</script>

</body>
</html>